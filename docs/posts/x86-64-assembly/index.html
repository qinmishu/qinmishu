<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.310">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="秦米书">
<meta name="dcterms.date" content="2023-10-21">

<title>亲密数 - x86-64汇编语言编程</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">亲密数</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">关于</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/qinmishu" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://blog.csdn.net/xuhx" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">x86-64汇编语言编程</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">x86-64</div>
                <div class="quarto-category">assembly</div>
                <div class="quarto-category">linux</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>秦米书 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 21, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#references" id="toc-references" class="nav-link active" data-scroll-target="#references">References</a></li>
  <li><a href="#general-notes" id="toc-general-notes" class="nav-link" data-scroll-target="#general-notes">General Notes</a>
  <ul>
  <li><a href="#misc" id="toc-misc" class="nav-link" data-scroll-target="#misc">misc</a></li>
  <li><a href="#hello-world-program" id="toc-hello-world-program" class="nav-link" data-scroll-target="#hello-world-program">Hello world program</a></li>
  <li><a href="#call-instruction-to-call-a-function" id="toc-call-instruction-to-call-a-function" class="nav-link" data-scroll-target="#call-instruction-to-call-a-function">call instruction to call a function</a></li>
  <li><a href="#the-64-bit-x86-c-calling-convention" id="toc-the-64-bit-x86-c-calling-convention" class="nav-link" data-scroll-target="#the-64-bit-x86-c-calling-convention">The 64 bit x86 C Calling Convention</a></li>
  <li><a href="#the-32-bit-x86-c-calling-convention" id="toc-the-32-bit-x86-c-calling-convention" class="nav-link" data-scroll-target="#the-32-bit-x86-c-calling-convention">The 32 bit x86 C calling Convention</a></li>
  </ul></li>
  <li><a href="#book-programming-from-the-ground-up-by-jonathan-bartlett-author" id="toc-book-programming-from-the-ground-up-by-jonathan-bartlett-author" class="nav-link" data-scroll-target="#book-programming-from-the-ground-up-by-jonathan-bartlett-author">Book Programming from the Ground Up by Jonathan Bartlett (Author)</a></li>
  <li><a href="#book-professional-assembly-language-by-richard-blum-good" id="toc-book-professional-assembly-language-by-richard-blum-good" class="nav-link" data-scroll-target="#book-professional-assembly-language-by-richard-blum-good">Book Professional Assembly Language by Richard Blum (Good)</a></li>
  <li><a href="#book-beginning-x64-assembly-programming-by-jo-van-hoey" id="toc-book-beginning-x64-assembly-programming-by-jo-van-hoey" class="nav-link" data-scroll-target="#book-beginning-x64-assembly-programming-by-jo-van-hoey">Book Beginning x64 Assembly Programming by Jo Van Hoey</a></li>
  <li><a href="#book-x64-assembly-language-step-by-step" id="toc-book-x64-assembly-language-step-by-step" class="nav-link" data-scroll-target="#book-x64-assembly-language-step-by-step">Book X64 Assembly Language Step by Step</a>
  <ul>
  <li><a href="#chap1-its-all-in-the-plan-understanding-what-computers-really-do" id="toc-chap1-its-all-in-the-plan-understanding-what-computers-really-do" class="nav-link" data-scroll-target="#chap1-its-all-in-the-plan-understanding-what-computers-really-do">Chap1 It’s all in the Plan: Understanding What Computers Really Do</a></li>
  <li><a href="#chap2-allien-bases-getting-your-arms-around-binary-and-hexadecimal" id="toc-chap2-allien-bases-getting-your-arms-around-binary-and-hexadecimal" class="nav-link" data-scroll-target="#chap2-allien-bases-getting-your-arms-around-binary-and-hexadecimal">Chap2 Allien Bases: Getting Your Arms Around Binary and Hexadecimal</a></li>
  <li><a href="#chap3-lifting-the-hood-discovering-what-computers-actually-are" id="toc-chap3-lifting-the-hood-discovering-what-computers-actually-are" class="nav-link" data-scroll-target="#chap3-lifting-the-hood-discovering-what-computers-actually-are">Chap3 Lifting the Hood: Discovering What Computers Actually Are</a></li>
  <li><a href="#chap4-location-registers-memory-addressing-and-knowing-where-things-are" id="toc-chap4-location-registers-memory-addressing-and-knowing-where-things-are" class="nav-link" data-scroll-target="#chap4-location-registers-memory-addressing-and-knowing-where-things-are">Chap4 Location: Registers, Memory Addressing, and Knowing Where Things Are</a></li>
  <li><a href="#chap5-the-right-to-assemble-the-process-of-creating-assembly-language-programs" id="toc-chap5-the-right-to-assemble-the-process-of-creating-assembly-language-programs" class="nav-link" data-scroll-target="#chap5-the-right-to-assemble-the-process-of-creating-assembly-language-programs">Chap5 The Right to Assemble: The Process of Creating Assembly Language Programs</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This is a note while studying x86-64 assembler.</p>
<section id="references" class="level1">
<h1>References</h1>
<p><a href="https://filippo.io/linux-syscall-table/">linux syscall table</a></p>
<p><a href="https://www.asciitable.com/">ascii table</a></p>
<p><a href="https://ftp.gnu.org/old-gnu/Manuals/gas-2.9.1/html_chapter/as_7.html">gnu assembler, or gas, or as</a></p>
</section>
<section id="general-notes" class="level1">
<h1>General Notes</h1>
<section id="misc" class="level2">
<h2 class="anchored" data-anchor-id="misc">misc</h2>
<p>GCC(Gnu Compiler Collection) is a front end. It will call <code>as</code> and <code>ld</code>. The process can be viewed if we use <code>-v</code> argument of gcc.</p>
<p>Using <code>-g</code> argument will embed debug info in the object file. E.g. <code>gcc -c first.s -o first.o -g</code>. After that, we are able to use <code>list</code> in GDB to view the source code.</p>
<p>Below table lists the size of x86-64 memory/registers. Some is different from ARM. For example, in ARM, A <code>.word</code> means 32 bits.</p>
<table class="table">
<thead>
<tr class="header">
<th>term</th>
<th>size (bits)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>byte</td>
<td>8</td>
</tr>
<tr class="even">
<td>word</td>
<td>16</td>
</tr>
<tr class="odd">
<td>dword</td>
<td>32</td>
</tr>
<tr class="even">
<td>qword</td>
<td>64</td>
</tr>
</tbody>
</table>
<p>In x86-64, use <code>.long</code> or <code>.int</code> to specify 64 bits integer. In ARM, use <code>.word</code> to specify 32 bits integer. Note, <code>.word</code> or <code>.short</code> may have different lengths in different machine. They are machine dependent.</p>
<p>STDIN file descriptor is 0. STDOUT file descriptor is 1. STDERR file descriptor is 2.</p>
<p>The labels in the assembly program begins with <code>_</code>, e.g.&nbsp;<code>_start</code>, is due to the convention of C compiler. It is the simple name mangaling. <code>C++</code> has more complex name mangling.</p>
</section>
<section id="hello-world-program" class="level2">
<h2 class="anchored" data-anchor-id="hello-world-program">Hello world program</h2>
<p>The program is copied from <a href="https://www.youtube.com/watch?v=3nYHV5zIQGA&amp;list=PLvv0ScY6vfd9BSBznpARlKGziF1xrlU54&amp;index=1">x86-64 Assembly on youtube, from Mike Shah</a></p>
<p>It refers to the <a href="https://filippo.io/linux-syscall-table/">linux syscall table</a></p>
<p>In intel format.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1"></a>/*first<span class="op">.</span>s<span class="op">*/</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>.intel_syntax noprefix</span>
<span id="cb1-3"><a href="#cb1-3"></a>.global _start </span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">.hello.str:</span> </span>
<span id="cb1-5"><a href="#cb1-5"></a>    .ascii <span class="st">"12345678\n"</span> </span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a>.text </span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">_start:</span> </span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="bu">movq</span> <span class="kw">rbp</span><span class="op">,</span> <span class="kw">rsp</span> </span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="bu">movq</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">1</span>  </span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="bu">movq</span> <span class="kw">rdi</span><span class="op">,</span> <span class="dv">1</span>  </span>
<span id="cb1-13"><a href="#cb1-13"></a>    leaq <span class="kw">rsi</span><span class="op">,</span> <span class="op">.</span>hello<span class="op">.</span>str  </span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="bu">movq</span> <span class="kw">rdx</span><span class="op">,</span> <span class="dv">9</span>  </span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="cf">syscall</span> </span>
<span id="cb1-16"><a href="#cb1-16"></a>    </span>
<span id="cb1-17"><a href="#cb1-17"></a>    <span class="bu">movq</span> <span class="kw">rax</span><span class="op">,</span> <span class="dv">60</span>  </span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="bu">movq</span> <span class="kw">rdi</span><span class="op">,</span> <span class="dv">0</span>  </span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="cf">syscall</span> </span>
<span id="cb1-20"><a href="#cb1-20"></a>    </span>
<span id="cb1-21"><a href="#cb1-21"></a>    <span class="bu">pop</span> <span class="kw">rbp</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To build it.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">as</span> <span class="at">-o</span> first.o first.s </span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">ld</span> <span class="at">-o</span> first first.o </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In AT&amp;T format.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1"></a>/*first<span class="op">.</span>s<span class="op">*/</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>.global _start </span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="fu">.hello.str:</span> </span>
<span id="cb3-5"><a href="#cb3-5"></a>    .ascii <span class="st">"12345678\n"</span> </span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a>.text </span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="fu">_start:</span> </span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="bu">movq</span> <span class="op">%</span><span class="kw">rsp</span><span class="op">,</span> <span class="op">%</span><span class="kw">rbp</span> </span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">1</span><span class="op">,</span> <span class="op">%</span><span class="kw">rax</span>    </span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">1</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span>   </span>
<span id="cb3-13"><a href="#cb3-13"></a>    leaq <span class="op">.</span>hello<span class="op">.</span>str<span class="op">,</span> <span class="op">%</span><span class="kw">rsi</span>    </span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">9</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdx</span>  </span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="cf">syscall</span> </span>
<span id="cb3-16"><a href="#cb3-16"></a>    </span>
<span id="cb3-17"><a href="#cb3-17"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">60</span><span class="op">,</span> <span class="op">%</span><span class="kw">rax</span>  </span>
<span id="cb3-18"><a href="#cb3-18"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">0</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span>   </span>
<span id="cb3-19"><a href="#cb3-19"></a>    <span class="cf">syscall</span> </span>
<span id="cb3-20"><a href="#cb3-20"></a>    </span>
<span id="cb3-21"><a href="#cb3-21"></a>    <span class="bu">pop</span> <span class="op">%</span><span class="kw">rbp</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To build it. The below 2 ways are both OK.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">as</span> <span class="at">-o</span> first.o first.s </span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">ld</span> <span class="at">-o</span> first first.o </span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">gcc</span> <span class="at">-c</span> first.s <span class="at">-o</span> first.o </span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="fu">ld</span> <span class="at">-o</span> first first.o </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="call-instruction-to-call-a-function" class="level2">
<h2 class="anchored" data-anchor-id="call-instruction-to-call-a-function">call instruction to call a function</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1"></a>/*first<span class="op">.</span>s<span class="op">*/</span></span>
<span id="cb5-2"><a href="#cb5-2"></a># there is also <span class="op">.</span>bss segment for <span class="op">not</span> initialized global data </span>
<span id="cb5-3"><a href="#cb5-3"></a>.<span class="bu">data</span> </span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="fu">.hello.str:</span> </span>
<span id="cb5-5"><a href="#cb5-5"></a>    .ascii <span class="st">"12345678\n"</span> </span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>.text </span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="fu">_write_str:</span> </span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="bu">movq</span> <span class="op">%</span><span class="kw">rsp</span><span class="op">,</span> <span class="op">%</span><span class="kw">rbp</span> </span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">1</span><span class="op">,</span> <span class="op">%</span><span class="kw">rax</span>    </span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">1</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span>   </span>
<span id="cb5-13"><a href="#cb5-13"></a>    leaq <span class="op">.</span>hello<span class="op">.</span>str<span class="op">,</span> <span class="op">%</span><span class="kw">rsi</span>    </span>
<span id="cb5-14"><a href="#cb5-14"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">9</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdx</span>  </span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="cf">syscall</span> </span>
<span id="cb5-16"><a href="#cb5-16"></a>    <span class="cf">ret</span> </span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="fu">_exit:</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">60</span><span class="op">,</span> <span class="op">%</span><span class="kw">rax</span>  </span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="bu">movq</span> <span class="op">$</span><span class="bn">0</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span>   </span>
<span id="cb5-20"><a href="#cb5-20"></a>    <span class="cf">syscall</span> </span>
<span id="cb5-21"><a href="#cb5-21"></a>    <span class="cf">ret</span> </span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a>.global _start </span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="fu">_start:</span> </span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="cf">call</span> _write_str </span>
<span id="cb5-26"><a href="#cb5-26"></a>    <span class="cf">call</span> _exit </span>
<span id="cb5-27"><a href="#cb5-27"></a>    <span class="bu">pop</span> <span class="op">%</span><span class="kw">rbp</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-64-bit-x86-c-calling-convention" class="level2">
<h2 class="anchored" data-anchor-id="the-64-bit-x86-c-calling-convention">The 64 bit x86 C Calling Convention</h2>
<p>The section is copied from <a href="https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf">x86-64 call convention</a>. It is for Linux. Microsoft windows does not follow the same convention. Refer to <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">x64 calling convention, Microsoft</a>.</p>
<p>pop, push, call, ret instructions.</p>
<p>The caller’s rules:</p>
<ol type="1">
<li><p>Before calling a subroutine, the caller should save the contents of certain registers that are designated caller-saved. The caller-saved registers are r10, r11, and any registers that parameters are put into. If you want the contents of these registers to be preserved across the subroutine call, push them onto the stack.</p></li>
<li><p>To pass parameters to the subroutine, we put up to six of them into registers (in order: rdi, rsi, rdx, rcx, r8, r9). If there are more than six parameters to the subroutine, then push the rest onto the stack in reverse order (i.e.&nbsp;last parameter first) – since the stack grows down, the first of the extra parameters (really the seventh parameter) parameter will be stored at the lowest address (this inversion of parameters was historically used to allow functions to be passed a variable number of parameters).</p></li>
<li><p>To call the subroutine, use the <code>call</code> instruction. This instruction places the return address on top of the parameters on the stack, and branches to the subroutine code.</p></li>
<li><p>After the subroutine returns, (i.e.&nbsp;immediately following the call instruction) the caller must remove any additional parameters (beyond the six stored in registers) from stack. This restores the stack to its state before the call was performed.</p></li>
<li><p>The caller can expect to find the return value of the subroutine in the register RAX.</p></li>
<li><p>The caller restores the contents of caller-saved registers (r10, r11, and any in the parameter passing registers) by popping them off of the stack. The caller can assume that no other registers were modified by the subroutine.</p></li>
</ol>
<p>The Callee’s Rules:</p>
<ol type="1">
<li><p>Allocate local variables by using registers or making space on the stack. Recall, the stack grows down, so to make space on the top of the stack, the stack pointer should be decremented. The amount by which the stack pointer is decremented depends on the number of local variables needed. For example, if a local float and a local long (12 bytes total) were required, the stack pointer would need to be decremented by 12 to make space for these local variables: <code>sub rsp, 12</code>. As with parameters, local variables will be located at known offsets from the stack pointer.</p></li>
<li><p>Next, the values of any registers that are designated callee-saved that will be used by the function must be saved. To save registers, push them onto the stack. The callee-saved registers are RBX, RBP, and R12 through R15 (RSP will also be preserved by the call convention, but need not be pushed on the stack during this step). After these three actions are performed, the actual operation of the subroutine may proceed. When the subroutine is ready to return, the call convention rules continue.</p></li>
<li><p>When the function is done, the return value for the function should be placed in RAX if it is not already there.</p></li>
<li><p>The function must restore the old values of any callee-saved registers (RBX, RBP, and R12 through R15) that were modified. The register contents are restored by popping them from the stack. Note, the registers should be popped in the inverse order that they were pushed.</p></li>
<li><p>Next, we deallocate local variables. The easiest way to do this is to add to RSP the same amount that was subtracted from it in step 1.</p></li>
<li><p>Finally, we return to the caller by executing a ret instruction. This instruction will find and remove the appropriate return address from the stack.</p></li>
</ol>
<p>If you look at the assembly generated by some compilers, you will see a few extra commands in there in the callee’s prologue:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb6-1"><a href="#cb6-1"></a><span class="bu">push</span> <span class="kw">rbp</span> <span class="co">; at the start of the callee </span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="bu">mov</span> <span class="kw">rbp</span><span class="op">,</span> <span class="kw">rsp</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>... </span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="bu">pop</span> <span class="kw">rbp</span> <span class="co">; just before the ending `ret` </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code is unnecessary, and is a hold-over from the 32-bit calling convention. You can tell the compiler to not include this code by invoking it with the <code>-fomit-frame-pointer</code> flag.</p>
<p>It might be noted that the callee’s rules fall cleanly into two halves that are basically mirror images of one another. The first half of the rules apply to the beginning of the function, and are therefor commonly said to define the prologue to the function. The latter half of the rules apply to the end of the function, and are thus commonly said to define the epilogue of the function.</p>
</section>
<section id="the-32-bit-x86-c-calling-convention" class="level2">
<h2 class="anchored" data-anchor-id="the-32-bit-x86-c-calling-convention">The 32 bit x86 C calling Convention</h2>
<p>The section is copied from <a href="https://aaronbloomfield.github.io/pdr/book/x86-32bit-ccc-chapter.pdf">x86 32 bit call convention</a>.</p>
<p>The Caller’s Rules</p>
<ol type="1">
<li><p>Bfore calling a subroutine, the caller should save the contents of certain registers that are designated caller-saved. The caller-saved registers are EAX, ECX, EDX. If you want the contents of these registers to be preserved across the subroutine call, push them onto the stack</p></li>
<li><p>To pass parameters to the subroutine, push them onto the stack before the call. The parameters should be pushed in inverted order (i.e.&nbsp;last parameter first) – since the stack grows down, the first parameter will be stored at the lowest address (this inversion of parameters was historically used to allow functions to be passed a variable number of parameters).</p></li>
<li><p>To call the subroutine, use the call instruction. This instruction places the return address on top of the parameters on the stack, and branches to the subroutine code.</p></li>
<li><p>After the subroutine returns, (i.e.&nbsp;immediately following the call instruction) the caller must remove the parameters from stack. This restores the stack to its state before the call was performed.</p></li>
<li><p>The caller can expect to find the return value of the subroutine in the register EAX.</p></li>
<li><p>The caller restores the contents of caller-saved registers (EAX, ECX, EDX) by popping them off of the stack. The caller can assume that no other registers were modified by the subroutine.</p></li>
</ol>
<p>The Callee’s Rules</p>
<ol type="1">
<li>At the beginning of the subroutine, the function should push the value of EBP onto the stack, and then copy the value of ESP into EBP using the following instructions:</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb7-1"><a href="#cb7-1"></a><span class="bu">push</span> <span class="kw">ebp</span> </span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="bu">mov</span> <span class="kw">ebp</span><span class="op">,</span> <span class="kw">esp</span> <span class="co">;Intel style instead of AT&amp;T style </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The reason for this initial action is the maintenance of the base pointer, EBP. The base pointer is used by convention as a point of reference for finding parameters and local variables on the stack. Essentially, when any subroutine is executing, the base pointer is a “snapshot” of the stack pointer value from when the subroutine started executing. Parameters and local variables will always be located at known, constant offsets away from the base pointer value. We push the old base pointer value at the beginning of the subroutine so that we can later restore the appropriate base pointer value for the caller when the subroutine returns. Remember, the caller isn’t expecting the subroutine to change the value of the base pointer. We then move the stack pointer into EBP to obtain our point of reference for accessing parameters and local variables.</p>
<ol start="2" type="1">
<li>Next, allocate local variables by making space on the stack. Recall, the stack grows down, so to make space on the top of the stack, the stack pointer should be decremented. The amount by which the stack pointer is decremented depends on the number of local variables needed. For example, if 3 local integers (4 bytes each) were required, the stack pointer would need to be decremented by 12 to make space for these local variables. I.e.:</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1"></a><span class="bu">sub</span> <span class="kw">esp</span><span class="op">,</span> <span class="dv">12</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As with parameters, local variables will be located at known offsets from the base pointer.</p>
<ol start="3" type="1">
<li><p>Next, the values of any registers that are designated callee-saved that will be used by the function must be saved. To save registers, push them onto the stack. The callee-saved registers are EBX, EDI and ESI (ESP and EBP will also be preserved by the call convention, but need not be pushed on the stack during this step). After these three actions are performed, the actual operation of the subroutine may proceed. When the subroutine is ready to return, the call convention rules continue:</p></li>
<li><p>When the function is done, the return value for the function should be placed in EAX if it is not already there.</p></li>
<li><p>The function must restore the old values of any callee-saved registers (EBX, EDI and ESI) that were modified. The register contents are restored by popping them from the stack. Note, the registers should be popped in the inverse order that they were pushed.</p></li>
<li><p>Next, we deallocate local variables. The obvious way to do this might be to add the appropriate value to the stack pointer (since the space was allocated by subtracting the needed amount from the stack pointer). In practice, a less error-prone way to deallocate the variables is to move the value in the base pointer into the stack pointer, i.e.:</p></li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb9-1"><a href="#cb9-1"></a><span class="bu">mov</span> <span class="kw">esp</span><span class="op">,</span> <span class="kw">ebp</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This trick works because the base pointer always contains the value that the stack pointer contained immediately prior to the allocation of the local variables.</p>
<ol start="7" type="1">
<li><p>Immediately before returning, we must restore the caller’s base pointer value by popping EBP off the stack. Remember, the first thing we did on entry to the subroutine was to push the base pointer to save its old value.</p></li>
<li><p>Finally, we return to the caller by executing a ret instruction. This instruction will find and remove the appropriate return address from the stack.</p></li>
</ol>
</section>
</section>
<section id="book-programming-from-the-ground-up-by-jonathan-bartlett-author" class="level1">
<h1>Book Programming from the Ground Up by Jonathan Bartlett (Author)</h1>
<p>Programming from the Ground Up uses Linux assembly language to teach new programmers the most important concepts in programming.</p>
</section>
<section id="book-professional-assembly-language-by-richard-blum-good" class="level1">
<h1>Book Professional Assembly Language by Richard Blum (Good)</h1>
<p>It is said that it uses the AT&amp;T syntax. And uses the GNU AS assembler. But seems it is for 32 bit X86.</p>
</section>
<section id="book-beginning-x64-assembly-programming-by-jo-van-hoey" class="level1">
<h1>Book Beginning x64 Assembly Programming by Jo Van Hoey</h1>
<p>It includes introductions on asm on both Linux and Windows. It also include some advanced instructions for example AVX, SSE, etc.</p>
</section>
<section id="book-x64-assembly-language-step-by-step" class="level1">
<h1>Book X64 Assembly Language Step by Step</h1>
<p>Notes while I read the book.</p>
<section id="chap1-its-all-in-the-plan-understanding-what-computers-really-do" class="level2">
<h2 class="anchored" data-anchor-id="chap1-its-all-in-the-plan-understanding-what-computers-really-do">Chap1 It’s all in the Plan: Understanding What Computers Really Do</h2>
<p>A computer program is a list of steps and tests, nothing more.</p>
<p>A test is the sort of either/or decision we make. - First, you take a look at sth that can go one of two way. - Then you do one of two things, depending on what you saw when you took a look.</p>
</section>
<section id="chap2-allien-bases-getting-your-arms-around-binary-and-hexadecimal" class="level2">
<h2 class="anchored" data-anchor-id="chap2-allien-bases-getting-your-arms-around-binary-and-hexadecimal">Chap2 Allien Bases: Getting Your Arms Around Binary and Hexadecimal</h2>
<p>octal</p>
<p>hexadecimal</p>
<p>binary</p>
</section>
<section id="chap3-lifting-the-hood-discovering-what-computers-actually-are" class="level2">
<h2 class="anchored" data-anchor-id="chap3-lifting-the-hood-discovering-what-computers-actually-are">Chap3 Lifting the Hood: Discovering What Computers Actually Are</h2>
<p>A bit is a single binary digit, either 1 or 0.</p>
<p>A byte is eight bits.</p>
<p>Two bytes side by side are called a word.</p>
<p>Two words side by side are called a double word.</p>
<p>A quad word consists of two double words.</p>
<p>A group of four bits is called a nybble.</p>
</section>
<section id="chap4-location-registers-memory-addressing-and-knowing-where-things-are" class="level2">
<h2 class="anchored" data-anchor-id="chap4-location-registers-memory-addressing-and-knowing-where-things-are">Chap4 Location: Registers, Memory Addressing, and Knowing Where Things Are</h2>
<p>The skill of assembly language consists of a deep comprehension of memory addressing. Everything else is details – and easy details, at that.</p>
<p>There are a fair number of different ways to address memory in the Intel/AMD CPU family. Each of these ways is called a Memory Model. There are 3 major memory models that you can use with the more recent members of the Intel family, and a number of minor variations on those three, especially the one in the middle.</p>
<p>Real mode flat model.</p>
<p>Real mode segmented model.</p>
<p>Protected-mode flat model(32-bit and 64-bit).</p>
<p>The 8080 was an 8-bit CPU(its general-purpose registers have 8-bits), meaning that it processed 8 bits of information at a time. However, it had 16 address lines coming out of it(it will address 64KB).</p>
<p>The 8080 memory-addressing scheme was very simple. You put a 16-bit address out on the address lines, and you got back the 8-bit value that was stored at that address.</p>
<p>The 8086 comes after 8080. It is 16-bit CPU. It has 20 address lines.</p>
<p>The 8080 is used a lot. Intel wanted to make it easy for people to translate older software from the 8080 to 8086. One way to do this was to make sure that a 16-bit addressing system such as that of the 8080 still worked. Even though the 8086 could address 16 times as much memory as the 8080(16x64KB=1MB), Intel setup the 8086 so that a program could take some 64 KB segment within that megabyte of memory and run entirely inside it, just as though it were the smaller 8080 memory system. This was done by the use of segment registers.</p>
<p>Speaking of the 8086 and 8088, there are 4 segment registers(CS, DS, …).</p>
<p>This was very wise short-term thinking and catastrophically bad long-term thinking. Programs that needed more than 64KB of memory at a time had to use memory in 64KB chunks, switching between chunks by switching values into and out of segment registers.</p>
<p>To maintain backward compatibility with the ancient 8086 and 8088, newer CPUs were given the power to limit themselves to what the older chips could address and execute. When a Pentium-class or better CPU needs to run software written for the real-mode segmented model, it pulls a neat trick that, temporarily, make it become an 8086. This was called virtual-86 mode, and it provided excellent backward compatibility for DOS software.</p>
<p>A segment may start every 16 bytes throughout the full megabyte of real memory.</p>
<p>CS, DS, SS, ES, FS, GS: Segment registers. All segment registers are 16 bits in size, irrespective of the CPU. FS and GS exist only in the 386 and later Intel x86 32-bit CPUs.</p>
<p>CS: Code Segment</p>
<p>DS: Data Segment</p>
<p>SS: Stack Segment</p>
<p>ES: Extra segment</p>
<p>FS, GS: Clones of ES</p>
<p>Segment registers become useless in application programming in X86-64. Operating systems use two of them for special purposes.</p>
<p>Do Intel’s x86-64 CPUs have 64 address lines? No (48 or 52).</p>
<p>In the x86-64 world, CPUs have 14 general purpose 64-bit registers, plus SP and BP.</p>
<p>There are eight 16-bit general-purpose registers: AX, BX, CX, DX, BP, SI, DI, SP (8086, 8088, 80186 and 80286).</p>
<p>EAX, EBX, ECX, EDX, EBP, ESI, EDI, ESP. (32 bitS)</p>
<p>RAX, RBX, RCX, RDX, RBP, RSI, RDI, RSP. R8 to R15. (64 BITS)</p>
<p>RAX(EAX(AX(AH,AL)))</p>
<p>RBX(EBX(BX(BH,BL)))</p>
<p>RCX(ECX(CX(CH,CL)))</p>
<p>RDX(EDX(DX(DH,DL)))</p>
<p>RSI(ESI(SI(SIL))) and so on for RDI, RSP.</p>
<p>RIP, EIP, IP</p>
<p>The new x64 registers R8-R15 can be addressed as 64 bits, 32 bits, 16 bits, and 8 bits. However, the AH/AL scheme for the low 16 bits is a trick reserved for only RAX-RDX. The naming scheme for the R registers provides a mnemonic: D for double word, W for word, and B for byte. For example, if you want to deal with the lowest 8 bits of R8, you use the name R8B. Don’t make the beginner’s mistake of assuming that R8, R8D, R8W, and R8B are four separate and independent registers! A better metaphor is to think of the register names as country/state/county/city.</p>
<p>IP register.</p>
<p>While executing a program, the CPU uses IP to keep track of where it is in the current code segment. Instructions come in different sizes, ranging typically from 1 to 15 bytes. The CPU knows the size of each instruction it executes.</p>
<p>IP is notable in being the only register that can neither be read nor written to directly.</p>
<p>Flags register.</p>
<p>RFLAGS, EFLAGS, FLAGS. When the flag’s value is 1, we say that the flag is set. When the flag’s value is 0, we say that the flag is cleared.</p>
<p>Math Coprocessors and Their Registers (may be 128 bits or 256 bits)</p>
<p>Real-Mode Flat Model</p>
<p>Real-Mode Segmented Model</p>
<p>32-bit Protected Mode Flat Model</p>
<p>64-bit Long Mode</p>
</section>
<section id="chap5-the-right-to-assemble-the-process-of-creating-assembly-language-programs" class="level2">
<h2 class="anchored" data-anchor-id="chap5-the-right-to-assemble-the-process-of-creating-assembly-language-programs">Chap5 The Right to Assemble: The Process of Creating Assembly Language Programs</h2>
<p>page 103</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>