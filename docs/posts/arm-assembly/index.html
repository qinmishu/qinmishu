<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.310">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="秦米书">
<meta name="dcterms.date" content="2023-04-06">

<title>亲密数 - ARM汇编语言编程</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">亲密数</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">关于</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/qinmishu" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://blog.csdn.net/xuhx" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">ARM汇编语言编程</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">arm</div>
                <div class="quarto-category">assembly</div>
                <div class="quarto-category">raspberry-pi</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>秦米书 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 6, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#reference" id="toc-reference" class="nav-link active" data-scroll-target="#reference">Reference</a></li>
  <li><a href="#first-arm-assembly-program" id="toc-first-arm-assembly-program" class="nav-link" data-scroll-target="#first-arm-assembly-program">01 - first arm assembly program</a></li>
  <li><a href="#registers-and-basic-arithmetic" id="toc-registers-and-basic-arithmetic" class="nav-link" data-scroll-target="#registers-and-basic-arithmetic">02 - Registers and basic arithmetic</a></li>
  <li><a href="#memory-addresses.-load-and-store." id="toc-memory-addresses.-load-and-store." class="nav-link" data-scroll-target="#memory-addresses.-load-and-store.">03 - Memory, addresses. Load and store.</a></li>
  <li><a href="#gdb" id="toc-gdb" class="nav-link" data-scroll-target="#gdb">04 - GDB</a></li>
  <li><a href="#branches" id="toc-branches" class="nav-link" data-scroll-target="#branches">05 - Branches</a></li>
  <li><a href="#control-structures" id="toc-control-structures" class="nav-link" data-scroll-target="#control-structures">06 - Control structures</a></li>
  <li><a href="#indexing-modes" id="toc-indexing-modes" class="nav-link" data-scroll-target="#indexing-modes">07 - Indexing modes</a></li>
  <li><a href="#数组和结构体" id="toc-数组和结构体" class="nav-link" data-scroll-target="#数组和结构体">08-数组和结构体</a>
  <ul>
  <li><a href="#索引模式的定义" id="toc-索引模式的定义" class="nav-link" data-scroll-target="#索引模式的定义">索引模式的定义</a></li>
  <li><a href="#什么是数组" id="toc-什么是数组" class="nav-link" data-scroll-target="#什么是数组">什么是数组</a></li>
  <li><a href="#什么是结构体" id="toc-什么是结构体" class="nav-link" data-scroll-target="#什么是结构体">什么是结构体</a></li>
  <li><a href="#naive-approach-without-indexing-modes" id="toc-naive-approach-without-indexing-modes" class="nav-link" data-scroll-target="#naive-approach-without-indexing-modes">Naive approach without indexing modes</a></li>
  <li><a href="#indexing-modes-1" id="toc-indexing-modes-1" class="nav-link" data-scroll-target="#indexing-modes-1">Indexing modes</a>
  <ul>
  <li><a href="#non-updating-indexing-modes" id="toc-non-updating-indexing-modes" class="nav-link" data-scroll-target="#non-updating-indexing-modes">Non updating indexing modes</a></li>
  <li><a href="#updating-indexing-modes" id="toc-updating-indexing-modes" class="nav-link" data-scroll-target="#updating-indexing-modes">Updating indexing modes</a>
  <ul>
  <li><a href="#post-indexing-modes" id="toc-post-indexing-modes" class="nav-link" data-scroll-target="#post-indexing-modes">Post-indexing modes</a></li>
  <li><a href="#pre-indexing-modes" id="toc-pre-indexing-modes" class="nav-link" data-scroll-target="#pre-indexing-modes">Pre-indexing modes</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#approach-using-indexing-modes" id="toc-approach-using-indexing-modes" class="nav-link" data-scroll-target="#approach-using-indexing-modes">approach using indexing modes</a></li>
  <li><a href="#结构体" id="toc-结构体" class="nav-link" data-scroll-target="#结构体">结构体</a></li>
  </ul></li>
  <li><a href="#函数" id="toc-函数" class="nav-link" data-scroll-target="#函数">09-函数</a>
  <ul>
  <li><a href="#well-behaved-functions" id="toc-well-behaved-functions" class="nav-link" data-scroll-target="#well-behaved-functions">Well behaved functions</a></li>
  <li><a href="#calling-a-function" id="toc-calling-a-function" class="nav-link" data-scroll-target="#calling-a-function">Calling a function</a></li>
  <li><a href="#leaving-a-function" id="toc-leaving-a-function" class="nav-link" data-scroll-target="#leaving-a-function">Leaving a function</a></li>
  <li><a href="#returning-data-from-functions" id="toc-returning-data-from-functions" class="nav-link" data-scroll-target="#returning-data-from-functions">Returning data from functions</a></li>
  <li><a href="#hello-world-puts" id="toc-hello-world-puts" class="nav-link" data-scroll-target="#hello-world-puts">Hello world (puts)</a></li>
  <li><a href="#interaction-scanf-printf" id="toc-interaction-scanf-printf" class="nav-link" data-scroll-target="#interaction-scanf-printf">Interaction (scanf, printf)</a></li>
  <li><a href="#first-function-multiply-by-5" id="toc-first-function-multiply-by-5" class="nav-link" data-scroll-target="#first-function-multiply-by-5">First function (multiply by 5)</a></li>
  </ul></li>
  <li><a href="#functions.-the-stack" id="toc-functions.-the-stack" class="nav-link" data-scroll-target="#functions.-the-stack">10 Functions. The stack</a>
  <ul>
  <li><a href="#dynamic-activation" id="toc-dynamic-activation" class="nav-link" data-scroll-target="#dynamic-activation">Dynamic activation</a></li>
  <li><a href="#the-stack" id="toc-the-stack" class="nav-link" data-scroll-target="#the-stack">The stack</a></li>
  <li><a href="#first-approach-to-implement-the-factorial-function" id="toc-first-approach-to-implement-the-factorial-function" class="nav-link" data-scroll-target="#first-approach-to-implement-the-factorial-function">First approach to implement the factorial function</a></li>
  <li><a href="#do-it-better-using-ldm-and-stm" id="toc-do-it-better-using-ldm-and-stm" class="nav-link" data-scroll-target="#do-it-better-using-ldm-and-stm">Do it better using <code>ldm</code> and <code>stm</code></a></li>
  <li><a href="#factorial-again-using-stm-or-push-and-ldm-or-pop" id="toc-factorial-again-using-stm-or-push-and-ldm-or-pop" class="nav-link" data-scroll-target="#factorial-again-using-stm-or-push-and-ldm-or-pop">Factorial again using <code>stm or push</code> and <code>ldm or pop</code></a></li>
  </ul></li>
  <li><a href="#predication" id="toc-predication" class="nav-link" data-scroll-target="#predication">11 Predication</a></li>
  <li><a href="#loops-and-the-status-register" id="toc-loops-and-the-status-register" class="nav-link" data-scroll-target="#loops-and-the-status-register">12 loops and the status register</a>
  <ul>
  <li><a href="#operating-64-bit-numbers" id="toc-operating-64-bit-numbers" class="nav-link" data-scroll-target="#operating-64-bit-numbers">Operating 64 bit numbers</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This is a note while studing <a href="https://thinkingeek.com/arm-assembler-raspberry-pi/">ARM assembler in Raspberry Pi</a>. Most contents are copied from there to remember where I read to. You should read the original copy from the author.</p>
<section id="reference" class="level2">
<h2 class="anchored" data-anchor-id="reference">Reference</h2>
<p><a href="https://thinkingeek.com/arm-assembler-raspberry-pi/">ARM assembler in Raspberry Pi</a></p>
</section>
<section id="first-arm-assembly-program" class="level2">
<h2 class="anchored" data-anchor-id="first-arm-assembly-program">01 - first arm assembly program</h2>
<p>first.s</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1"></a>.global main </span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">main:</span> </span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">3</span> <span class="op">/*</span> r0 is a register<span class="op">,</span> <span class="op">#</span><span class="dv">3</span> is an immediate value <span class="op">*/</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    bx lr <span class="op">/*</span>branch <span class="op">and</span> exchange<span class="op">,</span> link register<span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="registers-and-basic-arithmetic" class="level2">
<h2 class="anchored" data-anchor-id="registers-and-basic-arithmetic">02 - Registers and basic arithmetic</h2>
<p>sum01.s</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb2-1"><a href="#cb2-1"></a>/* </span>
<span id="cb2-2"><a href="#cb2-2"></a>    Registers <span class="op">and</span> basic arithmetic </span>
<span id="cb2-3"><a href="#cb2-3"></a>    </span>
<span id="cb2-4"><a href="#cb2-4"></a>    r0 <span class="op">-</span> <span class="kw">r15</span><span class="op">,</span> <span class="dv">32</span> bits integer registers in Raspberry PI<span class="co">; </span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    </span>
<span id="cb2-6"><a href="#cb2-6"></a>    32 floating point registers<span class="co">; </span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    </span>
<span id="cb2-8"><a href="#cb2-8"></a>    A program to add r1 <span class="op">and</span> r2 <span class="op">and</span> put the result to r0<span class="co">; </span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    </span>
<span id="cb2-10"><a href="#cb2-10"></a>    A program to add r0 <span class="op">and</span> r1 <span class="op">and</span> put the result to r0<span class="co">; </span></span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a>*/ </span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>.global main </span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="fu">main:</span> </span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">3</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="bu">mov</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">4</span> </span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="bu">add</span> r0<span class="op">,</span> r1<span class="op">,</span> r2 </span>
<span id="cb2-20"><a href="#cb2-20"></a>    bx lr <span class="op">/*</span> link register <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>sum02.s</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a>/* </span>
<span id="cb3-3"><a href="#cb3-3"></a>    Registers <span class="op">and</span> basic arithmetic </span>
<span id="cb3-4"><a href="#cb3-4"></a>    </span>
<span id="cb3-5"><a href="#cb3-5"></a>    r0 <span class="op">-</span> <span class="kw">r15</span><span class="op">,</span> <span class="dv">32</span> bits integer registers in Raspberry PI<span class="co">; </span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    </span>
<span id="cb3-7"><a href="#cb3-7"></a>    32 floating point registers<span class="co">; </span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    </span>
<span id="cb3-9"><a href="#cb3-9"></a>    A program to add r1 <span class="op">and</span> r2 <span class="op">and</span> put the result to r0<span class="co">; </span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    </span>
<span id="cb3-11"><a href="#cb3-11"></a>    A program to add r0 <span class="op">and</span> r1 <span class="op">and</span> put the result to r0<span class="co">; </span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a>*/ </span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a>.global main </span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="fu">main:</span> </span>
<span id="cb3-18"><a href="#cb3-18"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">4</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">5</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>    <span class="bu">add</span> r0<span class="op">,</span> r0<span class="op">,</span> r1</span>
<span id="cb3-21"><a href="#cb3-21"></a>    bx lr <span class="op">/*</span> link register <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="memory-addresses.-load-and-store." class="level2">
<h2 class="anchored" data-anchor-id="memory-addresses.-load-and-store.">03 - Memory, addresses. Load and store.</h2>
<p>load01.s</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb4-1"><a href="#cb4-1"></a>/*</span>
<span id="cb4-2"><a href="#cb4-2"></a>    Memory<span class="op">,</span> addresses<span class="op">.</span> Load <span class="op">and</span> store<span class="op">.</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    </span>
<span id="cb4-4"><a href="#cb4-4"></a>    Difference between x86 <span class="op">and</span> ARM<span class="op">(</span>Advanced RISC Machines<span class="op">)</span>  </span>
<span id="cb4-5"><a href="#cb4-5"></a>    </span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="fu">ldr:</span> <span class="bu">load</span> to register </span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="fu">str:</span> <span class="bu">store</span> from register </span>
<span id="cb4-8"><a href="#cb4-8"></a>    </span>
<span id="cb4-9"><a href="#cb4-9"></a>    Address<span class="op">,</span> Labels </span>
<span id="cb4-10"><a href="#cb4-10"></a>    </span>
<span id="cb4-11"><a href="#cb4-11"></a>    Code<span class="op">,</span> Data </span>
<span id="cb4-12"><a href="#cb4-12"></a>    </span>
<span id="cb4-13"><a href="#cb4-13"></a>    .balign <span class="dt">byte</span> align </span>
<span id="cb4-14"><a href="#cb4-14"></a>    .<span class="dt">word</span> </span>
<span id="cb4-15"><a href="#cb4-15"></a>    </span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="fu">Sections:</span> .text<span class="op">,</span> <span class="op">.</span>data </span>
<span id="cb4-17"><a href="#cb4-17"></a>    </span>
<span id="cb4-18"><a href="#cb4-18"></a>    load01<span class="op">.</span>s <span class="op">&amp;</span> store01<span class="op">.</span>s </span>
<span id="cb4-19"><a href="#cb4-19"></a>*/</span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a>.<span class="bu">data</span> </span>
<span id="cb4-22"><a href="#cb4-22"></a></span>
<span id="cb4-23"><a href="#cb4-23"></a>.balign <span class="dv">4</span> </span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="fu">var1:</span> </span>
<span id="cb4-25"><a href="#cb4-25"></a>    .<span class="dt">word</span> <span class="dv">3</span> </span>
<span id="cb4-26"><a href="#cb4-26"></a>    </span>
<span id="cb4-27"><a href="#cb4-27"></a>.balign <span class="dv">4</span>   </span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="fu">var2:</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>    .<span class="dt">word</span> <span class="dv">6</span> </span>
<span id="cb4-30"><a href="#cb4-30"></a></span>
<span id="cb4-31"><a href="#cb4-31"></a>.text </span>
<span id="cb4-32"><a href="#cb4-32"></a>.balign <span class="dv">4</span> </span>
<span id="cb4-33"><a href="#cb4-33"></a>.global main </span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="fu">main:</span> </span>
<span id="cb4-35"><a href="#cb4-35"></a>    ldr r1<span class="op">,</span> addr_var1</span>
<span id="cb4-36"><a href="#cb4-36"></a>    ldr r1<span class="op">,[</span>r1<span class="op">]</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>    </span>
<span id="cb4-38"><a href="#cb4-38"></a>    ldr r2<span class="op">,</span> addr_var2</span>
<span id="cb4-39"><a href="#cb4-39"></a>    ldr r2<span class="op">,[</span>r2<span class="op">]</span></span>
<span id="cb4-40"><a href="#cb4-40"></a>    </span>
<span id="cb4-41"><a href="#cb4-41"></a>    <span class="bu">add</span> r0<span class="op">,</span>r1<span class="op">,</span>r2 </span>
<span id="cb4-42"><a href="#cb4-42"></a>    bx lr </span>
<span id="cb4-43"><a href="#cb4-43"></a>    </span>
<span id="cb4-44"><a href="#cb4-44"></a>    </span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="fu">addr_var1:</span> </span>
<span id="cb4-46"><a href="#cb4-46"></a>    .<span class="dt">word</span> var1 </span>
<span id="cb4-47"><a href="#cb4-47"></a><span class="fu">addr_var2:</span> </span>
<span id="cb4-48"><a href="#cb4-48"></a>    .<span class="dt">word</span> var2  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>store01.s</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1"></a>/*</span>
<span id="cb5-2"><a href="#cb5-2"></a>    Memory<span class="op">,</span> addresses<span class="op">.</span> Load <span class="op">and</span> store<span class="op">.</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>    </span>
<span id="cb5-4"><a href="#cb5-4"></a>    Difference between x86 <span class="op">and</span> ARM<span class="op">(</span>Advanced RISC Machines<span class="op">)</span>  </span>
<span id="cb5-5"><a href="#cb5-5"></a>    </span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="fu">ldr:</span> <span class="bu">load</span> to register </span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="fu">str:</span> <span class="bu">store</span> from register </span>
<span id="cb5-8"><a href="#cb5-8"></a>    </span>
<span id="cb5-9"><a href="#cb5-9"></a>    Address<span class="op">,</span> Labels </span>
<span id="cb5-10"><a href="#cb5-10"></a>    </span>
<span id="cb5-11"><a href="#cb5-11"></a>    Code<span class="op">,</span> Data </span>
<span id="cb5-12"><a href="#cb5-12"></a>    </span>
<span id="cb5-13"><a href="#cb5-13"></a>    .balign <span class="dt">byte</span> align </span>
<span id="cb5-14"><a href="#cb5-14"></a>    .<span class="dt">word</span> </span>
<span id="cb5-15"><a href="#cb5-15"></a>    </span>
<span id="cb5-16"><a href="#cb5-16"></a>    <span class="fu">Sections:</span> .text<span class="op">,</span> <span class="op">.</span>data </span>
<span id="cb5-17"><a href="#cb5-17"></a>    </span>
<span id="cb5-18"><a href="#cb5-18"></a>    load01<span class="op">.</span>s <span class="op">&amp;</span> store01<span class="op">.</span>s </span>
<span id="cb5-19"><a href="#cb5-19"></a>*/</span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a>.<span class="bu">data</span> </span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a>.balign <span class="dv">4</span> </span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="fu">var1:</span> </span>
<span id="cb5-25"><a href="#cb5-25"></a>    .<span class="dt">word</span> <span class="dv">0</span> </span>
<span id="cb5-26"><a href="#cb5-26"></a>    </span>
<span id="cb5-27"><a href="#cb5-27"></a>.balign <span class="dv">4</span>   </span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="fu">var2:</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>    .<span class="dt">word</span> <span class="dv">0</span>  </span>
<span id="cb5-30"><a href="#cb5-30"></a></span>
<span id="cb5-31"><a href="#cb5-31"></a>.text </span>
<span id="cb5-32"><a href="#cb5-32"></a>.balign <span class="dv">4</span> </span>
<span id="cb5-33"><a href="#cb5-33"></a>.global main </span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="fu">main:</span> </span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="bu">mov</span> r3<span class="op">,</span> <span class="op">#</span><span class="dv">6</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>    </span>
<span id="cb5-37"><a href="#cb5-37"></a>    ldr r1<span class="op">,</span> addr_var1</span>
<span id="cb5-38"><a href="#cb5-38"></a>    <span class="bu">str</span> r3<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>    </span>
<span id="cb5-40"><a href="#cb5-40"></a>    <span class="bu">mov</span> r3<span class="op">,</span> <span class="op">#</span><span class="dv">9</span></span>
<span id="cb5-41"><a href="#cb5-41"></a>    </span>
<span id="cb5-42"><a href="#cb5-42"></a>    ldr r1<span class="op">,</span> addr_var2</span>
<span id="cb5-43"><a href="#cb5-43"></a>    <span class="bu">str</span> r3<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span></span>
<span id="cb5-44"><a href="#cb5-44"></a></span>
<span id="cb5-45"><a href="#cb5-45"></a>    ldr r1<span class="op">,</span> addr_var1</span>
<span id="cb5-46"><a href="#cb5-46"></a>    ldr r1<span class="op">,[</span>r1<span class="op">]</span></span>
<span id="cb5-47"><a href="#cb5-47"></a>    </span>
<span id="cb5-48"><a href="#cb5-48"></a>    ldr r2<span class="op">,</span> addr_var2</span>
<span id="cb5-49"><a href="#cb5-49"></a>    ldr r2<span class="op">,[</span>r2<span class="op">]</span></span>
<span id="cb5-50"><a href="#cb5-50"></a>    </span>
<span id="cb5-51"><a href="#cb5-51"></a>    <span class="bu">add</span> r0<span class="op">,</span>r1<span class="op">,</span>r2 </span>
<span id="cb5-52"><a href="#cb5-52"></a>    bx lr </span>
<span id="cb5-53"><a href="#cb5-53"></a>    </span>
<span id="cb5-54"><a href="#cb5-54"></a>    </span>
<span id="cb5-55"><a href="#cb5-55"></a><span class="fu">addr_var1:</span> </span>
<span id="cb5-56"><a href="#cb5-56"></a>    .<span class="dt">word</span> var1 </span>
<span id="cb5-57"><a href="#cb5-57"></a><span class="fu">addr_var2:</span> </span>
<span id="cb5-58"><a href="#cb5-58"></a>    .<span class="dt">word</span> var2  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="gdb" class="level2">
<h2 class="anchored" data-anchor-id="gdb">04 - GDB</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># get help </span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="bu">help</span> </span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co"># get help of a command </span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="bu">help</span> disassemble </span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="bu">help</span> breakpoints </span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="ex">start</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="ex">stepi</span> </span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="ex">info</span> registers </span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co"># continue to run to the next breakpoint or the end </span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="cf">continue</span> </span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co"># print the addr of a </span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="ex">print</span> <span class="kw">&amp;</span><span class="ex">a</span> </span>
<span id="cb6-20"><a href="#cb6-20"></a></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co"># print the value of a with casting </span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="ex">print</span> <span class="er">(</span><span class="ex">int</span><span class="kw">)</span><span class="ex">a</span> </span>
<span id="cb6-23"><a href="#cb6-23"></a></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="co"># examine 10 decimal values starting from the address &amp;a </span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="ex">x/10d</span> <span class="kw">&amp;</span><span class="ex">a</span></span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="ex">disassemble</span> </span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co"># disassemble instructions from 0x000103d0 to the addr with offset +40 bytes </span></span>
<span id="cb6-30"><a href="#cb6-30"></a><span class="ex">disassemble</span> 0x000103d0,+40 </span>
<span id="cb6-31"><a href="#cb6-31"></a></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co"># set breakpoints at the address </span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="cf">break</span> <span class="ex">*0x000103f0</span></span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co"># query the current breakpoints </span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="ex">i</span> b </span>
<span id="cb6-37"><a href="#cb6-37"></a></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="co"># delete the 3rd breakpoint </span></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="ex">delete</span> 3 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="branches" class="level2">
<h2 class="anchored" data-anchor-id="branches">05 - Branches</h2>
<p>branch01.s</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb7-1"><a href="#cb7-1"></a>/*</span>
<span id="cb7-2"><a href="#cb7-2"></a>r0 <span class="op">-</span> <span class="kw">r15</span> </span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">r13:</span> sp<span class="op">,</span> stack pointer  </span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">r14:</span> link register </span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="fu">r15:</span> pc<span class="op">,</span> program counter<span class="op">,</span> IP<span class="op">,</span> instruction pointer </span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="fu">b:</span> branch </span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="fu">cmp:</span> <span class="bu">compare</span> </span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="fu">cpsr:</span> current progrm status register </span>
<span id="cb7-9"><a href="#cb7-9"></a>N <span class="op">(</span>negative<span class="op">),</span> Z <span class="op">(</span>zero<span class="op">),</span> C <span class="op">(</span>carry<span class="op">)</span> <span class="op">and</span> V <span class="op">(</span>overflow<span class="op">)</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>*/</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a>.text </span>
<span id="cb7-13"><a href="#cb7-13"></a>.global main </span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="fu">main:</span> </span>
<span id="cb7-15"><a href="#cb7-15"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">2</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>    b end </span>
<span id="cb7-17"><a href="#cb7-17"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">3</span> </span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="fu">end:</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>    bx lr </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>compare00.s</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1"></a>/*</span>
<span id="cb8-2"><a href="#cb8-2"></a>demonstrate how subtract operation affects the Carry bit of cpsr </span>
<span id="cb8-3"><a href="#cb8-3"></a>*/</span>
<span id="cb8-4"><a href="#cb8-4"></a>.text </span>
<span id="cb8-5"><a href="#cb8-5"></a>.global main </span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="fu">main:</span> </span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">2</span> </span>
<span id="cb8-8"><a href="#cb8-8"></a>    <span class="bu">mov</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">1</span> </span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="bu">cmp</span> r1<span class="op">,</span> r2 </span>
<span id="cb8-10"><a href="#cb8-10"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">0</span> </span>
<span id="cb8-11"><a href="#cb8-11"></a>    bx lr </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>compare01.s</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb9-1"><a href="#cb9-1"></a>/*</span>
<span id="cb9-2"><a href="#cb9-2"></a>*/</span>
<span id="cb9-3"><a href="#cb9-3"></a>.text </span>
<span id="cb9-4"><a href="#cb9-4"></a>.global main </span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="fu">main:</span> </span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">3</span> </span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="bu">mov</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">2</span> </span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="bu">cmp</span> r1<span class="op">,</span> r2 </span>
<span id="cb9-9"><a href="#cb9-9"></a>    beq case_eq</span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="fu">case_neq:</span> </span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">6</span>  </span>
<span id="cb9-12"><a href="#cb9-12"></a>    b end </span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="fu">case_eq:</span> </span>
<span id="cb9-14"><a href="#cb9-14"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">5</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="fu">end:</span> </span>
<span id="cb9-16"><a href="#cb9-16"></a>    bx lr </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>cpsr_decode.py</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>cpsr <span class="op">=</span> <span class="bn">0x20000010</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#cpsr is an integer </span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="kw">def</span> cpsr_decode(cpsr):</span>
<span id="cb10-4"><a href="#cb10-4"></a>    bit_names <span class="op">=</span> {} </span>
<span id="cb10-5"><a href="#cb10-5"></a>    bit_names[<span class="st">"n_bit"</span>] <span class="op">=</span> <span class="bn">0x80_00_00_00</span> <span class="co">#negative</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>    bit_names[<span class="st">"z_bit"</span>] <span class="op">=</span> <span class="bn">0x40_00_00_00</span> <span class="co">#zero </span></span>
<span id="cb10-7"><a href="#cb10-7"></a>    bit_names[<span class="st">"c_bit"</span>] <span class="op">=</span> <span class="bn">0x20_00_00_00</span> <span class="co">#carry </span></span>
<span id="cb10-8"><a href="#cb10-8"></a>    bit_names[<span class="st">"v_bit"</span>] <span class="op">=</span> <span class="bn">0x10_00_00_00</span> <span class="co">#overflow</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>    </span>
<span id="cb10-10"><a href="#cb10-10"></a>    <span class="cf">for</span> name,bit <span class="kw">in</span> bit_names.items():</span>
<span id="cb10-11"><a href="#cb10-11"></a>        <span class="cf">if</span> cpsr <span class="op">&amp;</span> bit <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb10-12"><a href="#cb10-12"></a>            <span class="bu">print</span>(name,<span class="st">"is set"</span>)</span>
<span id="cb10-13"><a href="#cb10-13"></a>        <span class="cf">else</span>:</span>
<span id="cb10-14"><a href="#cb10-14"></a>            <span class="bu">print</span>(name,<span class="st">"is not set"</span>)</span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a>cpsr_decode(cpsr) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="control-structures" class="level2">
<h2 class="anchored" data-anchor-id="control-structures">06 - Control structures</h2>
<p>if01.s</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb11-1"><a href="#cb11-1"></a>.text </span>
<span id="cb11-2"><a href="#cb11-2"></a>.global main </span>
<span id="cb11-3"><a href="#cb11-3"></a>/* check if the number in r1 is odd <span class="op">or</span> even<span class="op">*/</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="fu">main:</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">2022</span></span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="fu">if:</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>    tst r1<span class="op">,</span> <span class="op">#</span><span class="dv">1</span> <span class="op">/*</span> cpsr<span class="op">:</span> current program status register<span class="op">*/</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>    bne else</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="fu">then:</span> /* r1 is even <span class="op">*/</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">2</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>    b end_if </span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="fu">else:</span> /* r1 is odd <span class="op">*/</span> </span>
<span id="cb11-14"><a href="#cb11-14"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="fu">end_if:</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>    bx lr </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>loop01.s</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb12-1"><a href="#cb12-1"></a>.text </span>
<span id="cb12-2"><a href="#cb12-2"></a>.global main</span>
<span id="cb12-3"><a href="#cb12-3"></a>/* calculate the sum <span class="fl">1.</span><span class="op">.</span><span class="dv">22</span> <span class="op">*/</span> </span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="fu">main:</span> </span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">0</span> <span class="op">/*</span> store sum <span class="op">*/</span> </span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="bu">mov</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">1</span> <span class="op">/*</span> counter <span class="op">*/</span> </span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="fu">loop:</span> </span>
<span id="cb12-8"><a href="#cb12-8"></a>    <span class="bu">cmp</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">22</span> <span class="op">/*</span> cpsr updated <span class="op">*/</span> </span>
<span id="cb12-9"><a href="#cb12-9"></a>    bgt end_loop </span>
<span id="cb12-10"><a href="#cb12-10"></a>    <span class="bu">add</span> r1<span class="op">,</span> r1<span class="op">,</span> r2 </span>
<span id="cb12-11"><a href="#cb12-11"></a>    <span class="bu">add</span> r2<span class="op">,</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">1</span> </span>
<span id="cb12-12"><a href="#cb12-12"></a>    b loop </span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="fu">end_loop:</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>    <span class="bu">mov</span> r0<span class="op">,</span> r1 </span>
<span id="cb12-15"><a href="#cb12-15"></a>    bx lr </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="indexing-modes" class="level2">
<h2 class="anchored" data-anchor-id="indexing-modes">07 - Indexing modes</h2>
<p>shift01.s</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb13-1"><a href="#cb13-1"></a>/*</span>
<span id="cb13-2"><a href="#cb13-2"></a>ARM assembler in Raspberry Pi</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a>07 Indexing modes<span class="op">:</span> </span>
<span id="cb13-5"><a href="#cb13-5"></a>Allowed operands in instructions are collectively called indexing modes </span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a>shifted operand </span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a>operator<span class="op">/</span>operand </span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a>ldr<span class="op">,</span> str<span class="op">,</span> bxx </span>
<span id="cb13-13"><a href="#cb13-13"></a></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="bu">mov</span></span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="bu">add</span><span class="op">,</span> sub<span class="op">,</span> rsb<span class="op">,</span> cmp<span class="op">,</span> <span class="op">and,</span> tst</span>
<span id="cb13-17"><a href="#cb13-17"></a></span>
<span id="cb13-18"><a href="#cb13-18"></a>register<span class="op">/</span>immediate values </span>
<span id="cb13-19"><a href="#cb13-19"></a></span>
<span id="cb13-20"><a href="#cb13-20"></a>Syntax of most of the ARM instructions<span class="op">:</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>instruction Rdest<span class="op">,</span> Rsource1<span class="op">,</span> source2</span>
<span id="cb13-22"><a href="#cb13-22"></a></span>
<span id="cb13-23"><a href="#cb13-23"></a>source2 is either a register <span class="op">or</span> an immediate value</span>
<span id="cb13-24"><a href="#cb13-24"></a></span>
<span id="cb13-25"><a href="#cb13-25"></a>When source2 is a register<span class="op">,</span> we can combine it with a shift operation<span class="op">.</span> </span>
<span id="cb13-26"><a href="#cb13-26"></a></span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="bu">LSL</span> <span class="op">#</span>n</span>
<span id="cb13-28"><a href="#cb13-28"></a><span class="bu">LSL</span> Rsource3 </span>
<span id="cb13-29"><a href="#cb13-29"></a></span>
<span id="cb13-30"><a href="#cb13-30"></a>LSR <span class="op">#</span>n</span>
<span id="cb13-31"><a href="#cb13-31"></a>LSR Rsource3 </span>
<span id="cb13-32"><a href="#cb13-32"></a></span>
<span id="cb13-33"><a href="#cb13-33"></a>ASR <span class="op">#</span>n</span>
<span id="cb13-34"><a href="#cb13-34"></a>ASR Rsource3 </span>
<span id="cb13-35"><a href="#cb13-35"></a></span>
<span id="cb13-36"><a href="#cb13-36"></a><span class="bu">ROR</span> <span class="op">#</span>n </span>
<span id="cb13-37"><a href="#cb13-37"></a><span class="bu">ROR</span> Rsource3 </span>
<span id="cb13-38"><a href="#cb13-38"></a></span>
<span id="cb13-39"><a href="#cb13-39"></a>#n can be <span class="fl">1.</span><span class="op">.</span><span class="fl">31.</span> shift is an operation instead of an instruction<span class="op">.</span> shift operation can be <span class="op">used</span> to perform multiplication <span class="op">and</span> division<span class="op">.</span> </span>
<span id="cb13-40"><a href="#cb13-40"></a>*/</span>
<span id="cb13-41"><a href="#cb13-41"></a></span>
<span id="cb13-42"><a href="#cb13-42"></a>.text </span>
<span id="cb13-43"><a href="#cb13-43"></a>.global main </span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="fu">main:</span> </span>
<span id="cb13-45"><a href="#cb13-45"></a>    <span class="bu">mov</span> r0<span class="op">,#</span><span class="dv">2</span></span>
<span id="cb13-46"><a href="#cb13-46"></a>    /*<span class="bu">add</span> r0<span class="op">,</span> r0<span class="op">,</span> r0<span class="op">,</span> lsl <span class="op">#</span><span class="dv">1</span><span class="op">*/</span></span>
<span id="cb13-47"><a href="#cb13-47"></a>    <span class="bu">mov</span> r0<span class="op">,</span>r0<span class="op">,</span>lsl <span class="op">#</span><span class="dv">2</span></span>
<span id="cb13-48"><a href="#cb13-48"></a>    bx lr </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="数组和结构体" class="level2">
<h2 class="anchored" data-anchor-id="数组和结构体">08-数组和结构体</h2>
<p>以下内容为学习<a href="https://thinkingeek.com/2013/01/27/arm-assembler-raspberry-pi-chapter-8/" class="uri">https://thinkingeek.com/2013/01/27/arm-assembler-raspberry-pi-chapter-8/</a>的摘录.</p>
<section id="索引模式的定义" class="level3">
<h3 class="anchored" data-anchor-id="索引模式的定义">索引模式的定义</h3>
<p>These sets of allowed operands in instructions are collectively called indexing modes.</p>
</section>
<section id="什么是数组" class="level3">
<h3 class="anchored" data-anchor-id="什么是数组">什么是数组</h3>
<p>An array is a sequence of items of the same kind in memory.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1"></a><span class="dt">int</span> a<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="什么是结构体" class="level3">
<h3 class="anchored" data-anchor-id="什么是结构体">什么是结构体</h3>
<p>A structure (or record or tuple) is a sequence of items of possibly diferent kind.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">struct</span> my_struct</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="dt">char</span> f0<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="dt">int</span> f1<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="op">}</span> b<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="naive-approach-without-indexing-modes" class="level3">
<h3 class="anchored" data-anchor-id="naive-approach-without-indexing-modes">Naive approach without indexing modes</h3>
<p>array01.s, a program to set initial values 0..9 to a 10 elements array</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb16-1"><a href="#cb16-1"></a>.<span class="bu">data</span> </span>
<span id="cb16-2"><a href="#cb16-2"></a>.balign <span class="dv">4</span> </span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="fu">a:</span> .skip <span class="dv">40</span> </span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a>.text </span>
<span id="cb16-6"><a href="#cb16-6"></a>.global main </span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="fu">main:</span> </span>
<span id="cb16-8"><a href="#cb16-8"></a>    ldr r0<span class="op">,</span> addr_a </span>
<span id="cb16-9"><a href="#cb16-9"></a></span>
<span id="cb16-10"><a href="#cb16-10"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">0</span> </span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="fu">loop:</span> </span>
<span id="cb16-13"><a href="#cb16-13"></a>    <span class="bu">cmp</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">10</span> </span>
<span id="cb16-14"><a href="#cb16-14"></a>    beq loop_end </span>
<span id="cb16-15"><a href="#cb16-15"></a>    <span class="bu">add</span> r2<span class="op">,</span> r0<span class="op">,</span> r1<span class="op">,</span> lsl <span class="op">#</span><span class="dv">2</span>  </span>
<span id="cb16-16"><a href="#cb16-16"></a>    <span class="bu">str</span> r1<span class="op">,</span> <span class="op">[</span>r2<span class="op">]</span> </span>
<span id="cb16-17"><a href="#cb16-17"></a>    <span class="bu">add</span> r1<span class="op">,</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">1</span> </span>
<span id="cb16-18"><a href="#cb16-18"></a>    b loop </span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="fu">loop_end:</span> </span>
<span id="cb16-20"><a href="#cb16-20"></a>    bx lr </span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="fu">addr_a:</span> .<span class="dt">word</span> a </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="indexing-modes-1" class="level3">
<h3 class="anchored" data-anchor-id="indexing-modes-1">Indexing modes</h3>
<section id="non-updating-indexing-modes" class="level4">
<h4 class="anchored" data-anchor-id="non-updating-indexing-modes">Non updating indexing modes</h4>
<ol type="1">
<li>immediate value. The immediate cannot be larger than 12 bits(0..4096)</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb17-1"><a href="#cb17-1"></a>[Rsource1<span class="op">,</span> <span class="op">#+</span>immediate<span class="op">]</span> </span>
<span id="cb17-2"><a href="#cb17-2"></a>[Rsource1<span class="op">,</span> <span class="op">#-</span>immediate<span class="op">]</span></span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="bu">mov</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">3</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="bu">str</span> r2<span class="op">,</span> <span class="op">[</span>r1<span class="op">,</span> <span class="op">#+</span><span class="dv">12</span><span class="op">]</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>register</li>
</ol>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb18-1"><a href="#cb18-1"></a>[Rsource1<span class="op">,</span> <span class="op">+</span>Rsource2<span class="op">]</span> </span>
<span id="cb18-2"><a href="#cb18-2"></a>[Rsource1<span class="op">,</span> <span class="op">-</span>Rsource2<span class="op">]</span></span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="bu">mov</span> r2<span class="op">,</span> <span class="op">#</span><span class="dv">3</span>         <span class="op">/*</span> r2 ← <span class="dv">3</span> <span class="op">*/</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="bu">mov</span> r3<span class="op">,</span> <span class="op">#</span><span class="dv">12</span>        <span class="op">/*</span> r3 ← <span class="dv">12</span> <span class="op">*/</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="bu">str</span> r2<span class="op">,</span> <span class="op">[</span>r1<span class="op">,+</span>r3<span class="op">]</span>   <span class="op">/*</span> <span class="op">*(</span>r1 <span class="op">+</span> r3<span class="op">)</span> ← r2 <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>register with shift operation</li>
</ol>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb19-1"><a href="#cb19-1"></a>[Rsource1<span class="op">,</span> <span class="op">+</span>Rsource2<span class="op">,</span> shift_operation <span class="op">#</span>immediate<span class="op">]</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>[Rsource1<span class="op">,</span> <span class="op">-</span>Rsource2<span class="op">,</span> shift_operation <span class="op">#</span>immediate<span class="op">]</span></span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="bu">str</span> r2<span class="op">,</span> <span class="op">[</span>r1<span class="op">,</span> <span class="op">+</span>r2<span class="op">,</span> LSL <span class="op">#</span><span class="dv">2</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="updating-indexing-modes" class="level4">
<h4 class="anchored" data-anchor-id="updating-indexing-modes">Updating indexing modes</h4>
<p>In these indexing modes the Rsource1 register is updated with the address synthesized by the load or store instruction.</p>
<section id="post-indexing-modes" class="level5">
<h5 class="anchored" data-anchor-id="post-indexing-modes">Post-indexing modes</h5>
<ol start="4" type="1">
<li>The value of Rsource1 is used as the address for the load or store. Then Rsource1 is updated with the value of immediate after adding (or subtracting) it to Rsource1.</li>
</ol>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb20-1"><a href="#cb20-1"></a>[Rsource1<span class="op">],</span> <span class="op">#+</span>immediate</span>
<span id="cb20-2"><a href="#cb20-2"></a>[Rsource1<span class="op">],</span> <span class="op">#-</span>immediate</span>
<span id="cb20-3"><a href="#cb20-3"></a></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="bu">str</span> r2<span class="op">,</span> <span class="op">[</span>r1<span class="op">],</span> <span class="op">#</span><span class="dv">4</span>        <span class="op">/*</span> <span class="op">*</span>r1 ← r2 then r1 ← r1 <span class="op">+</span> <span class="dv">4</span> <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="5" type="1">
<li>register</li>
</ol>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb21-1"><a href="#cb21-1"></a>[Rsource1<span class="op">],</span> <span class="op">+</span>Rsource2</span>
<span id="cb21-2"><a href="#cb21-2"></a>[Rsource1<span class="op">],</span> <span class="op">-</span>Rsource2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="6" type="1">
<li>register with shift operation</li>
</ol>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb22-1"><a href="#cb22-1"></a>[Rsource1<span class="op">],</span> <span class="op">+</span>Rsource2<span class="op">,</span> shift_operation <span class="op">#</span>immediate </span>
<span id="cb22-2"><a href="#cb22-2"></a>[Rsource1<span class="op">],</span> <span class="op">-</span>Rsource2<span class="op">,</span> shift_operation <span class="op">#</span>immediate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="pre-indexing-modes" class="level5">
<h5 class="anchored" data-anchor-id="pre-indexing-modes">Pre-indexing modes</h5>
<ol start="7" type="1">
<li>immediate</li>
</ol>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb23-1"><a href="#cb23-1"></a>[Rsource1<span class="op">,</span> <span class="op">#+</span>immediate<span class="op">]!</span> </span>
<span id="cb23-2"><a href="#cb23-2"></a>[Rsource1<span class="op">,</span> <span class="op">#-</span>immediate<span class="op">]!</span></span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a>ldr r2<span class="op">,</span> <span class="op">[</span>r1<span class="op">,</span> <span class="op">#+</span><span class="dv">12</span><span class="op">]!</span>  <span class="op">/*</span> r1 ← r1 <span class="op">+</span> <span class="dv">12</span> then r2 ← <span class="op">*</span>r1 <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="8" type="1">
<li>register</li>
</ol>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb24-1"><a href="#cb24-1"></a>[Rsource1<span class="op">,</span> <span class="op">+</span>Rsource2<span class="op">]!</span> </span>
<span id="cb24-2"><a href="#cb24-2"></a>[Rsource1<span class="op">,</span> <span class="op">+</span>Rsource2<span class="op">]!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="9" type="1">
<li>register with shift operation</li>
</ol>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb25-1"><a href="#cb25-1"></a>[Rsource1<span class="op">,</span> <span class="op">+</span>Rsource2<span class="op">,</span> shift_operation <span class="op">#</span>immediate<span class="op">]!</span> </span>
<span id="cb25-2"><a href="#cb25-2"></a>[Rsource1<span class="op">,</span> <span class="op">-</span>Rsource2<span class="op">,</span> shift_operation <span class="op">#</span>immediate<span class="op">]!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="approach-using-indexing-modes" class="level3">
<h3 class="anchored" data-anchor-id="approach-using-indexing-modes">approach using indexing modes</h3>
<p>array02.s, a program to set initial values 0..9 to a 10 elements array, using indexing modes</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb26-1"><a href="#cb26-1"></a>.<span class="bu">data</span> </span>
<span id="cb26-2"><a href="#cb26-2"></a>.balign <span class="dv">4</span> </span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="fu">a:</span> .skip <span class="dv">40</span> </span>
<span id="cb26-4"><a href="#cb26-4"></a></span>
<span id="cb26-5"><a href="#cb26-5"></a>.text </span>
<span id="cb26-6"><a href="#cb26-6"></a>.global main </span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="fu">main:</span> </span>
<span id="cb26-8"><a href="#cb26-8"></a>    ldr r0<span class="op">,</span> addr_a </span>
<span id="cb26-9"><a href="#cb26-9"></a></span>
<span id="cb26-10"><a href="#cb26-10"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">0</span> </span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="fu">loop:</span> </span>
<span id="cb26-13"><a href="#cb26-13"></a>    <span class="bu">cmp</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">10</span> </span>
<span id="cb26-14"><a href="#cb26-14"></a>    beq loop_end </span>
<span id="cb26-15"><a href="#cb26-15"></a>    /*<span class="bu">add</span> r2<span class="op">,</span> r0<span class="op">,</span> r1<span class="op">,</span> lsl <span class="op">#</span><span class="dv">2</span> <span class="op">*/</span></span>
<span id="cb26-16"><a href="#cb26-16"></a>    <span class="bu">str</span> r1<span class="op">,</span> <span class="op">[</span>r0<span class="op">,</span> r1<span class="op">,</span> lsl <span class="op">#</span><span class="dv">2</span><span class="op">]</span> </span>
<span id="cb26-17"><a href="#cb26-17"></a>    <span class="bu">add</span> r1<span class="op">,</span> r1<span class="op">,</span> <span class="op">#</span><span class="dv">1</span> </span>
<span id="cb26-18"><a href="#cb26-18"></a>    b loop </span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="fu">loop_end:</span> </span>
<span id="cb26-20"><a href="#cb26-20"></a>    bx lr </span>
<span id="cb26-21"><a href="#cb26-21"></a><span class="fu">addr_a:</span> .<span class="dt">word</span> a </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="结构体" class="level3">
<h3 class="anchored" data-anchor-id="结构体">结构体</h3>
<p>略</p>
</section>
</section>
<section id="函数" class="level2">
<h2 class="anchored" data-anchor-id="函数">09-函数</h2>
<p>以下内容为学习<a href="https://thinkingeek.com/2013/02/02/arm-assembler-raspberry-pi-chapter-9/" class="uri">https://thinkingeek.com/2013/02/02/arm-assembler-raspberry-pi-chapter-9/</a>的摘录.</p>
<p>Functions are a way to reuse code.</p>
<p>AAPCS:Procedure Call Standard for ARM Architecture</p>
<table class="table">
<thead>
<tr class="header">
<th>Register</th>
<th>Register Alias</th>
<th>Description</th>
<th>Remark</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>r15</td>
<td>pc</td>
<td>Program Counter</td>
<td></td>
</tr>
<tr class="even">
<td>r14</td>
<td>lr</td>
<td>Link Register</td>
<td></td>
</tr>
<tr class="odd">
<td>r13</td>
<td>sp</td>
<td>Stack Pointer</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>cpsr</td>
<td>Current Program Status Register</td>
<td></td>
</tr>
</tbody>
</table>
<p>Functions can receive parameters. The first 4 parameters must be stored, sequentially, in the registers <code>r0</code>, <code>r1</code>, <code>r2</code> and <code>r3</code>.</p>
<section id="well-behaved-functions" class="level3">
<h3 class="anchored" data-anchor-id="well-behaved-functions">Well behaved functions</h3>
<p>A function must adhere, at least, to the following rules if we want it to be AAPCS compliant.</p>
<ul>
<li><p>A function should not make any assumption on the contents of the <code>cpsr</code>. So, at the entry of a function condition codes N, Z, C and V are unknown.</p></li>
<li><p>A function can freely modify registers <code>r0</code>, <code>r1</code>, <code>r2</code> and <code>r3</code>.</p></li>
<li><p>A function cannot assume anything on the contents of <code>r0</code>, <code>r1</code>, <code>r2</code> and <code>r3</code> unless they are playing the role of a parameter.</p></li>
<li><p>A function can freely modify <code>lr</code> but the value upon entering the function will be needed when leaving the function (so such value must be kept somewhere).</p></li>
<li><p>A function can modify all the remaining registers as long as their values are restored upon leaving the function. This includes <code>sp</code> and registers <code>r4</code> to <code>r11</code>.</p></li>
<li><p>This means that, after calling a function, we have to assume that (only) registers <code>r0</code>, <code>r1</code>, <code>r2</code>, <code>r3</code> and <code>lr</code> have been overwritten.</p></li>
</ul>
</section>
<section id="calling-a-function" class="level3">
<h3 class="anchored" data-anchor-id="calling-a-function">Calling a function</h3>
<p>direct call:</p>
<pre><code>bl label</code></pre>
<p>indirect call(first storing the address of the function into a register):</p>
<pre><code>blx Rsource1 /* Rsource1 means register operand1 */</code></pre>
<p>In both cases the behaviour is as follows: the address of the function (immediately encoded in the bl or using the value of the register in blx) is stored in pc. The address of the instruction following the bl or blx instruction is kept in lr.</p>
</section>
<section id="leaving-a-function" class="level3">
<h3 class="anchored" data-anchor-id="leaving-a-function">Leaving a function</h3>
<p>A well behaved function, as stated above, will have to keep the initial value of lr somewhere. When leaving the function, we will retrieve that value and put it in some register (it can be lr again but this is not mandatory). Then we will bx Rsource1 (we could use blx as well but the latter would update lr which is useless here).</p>
</section>
<section id="returning-data-from-functions" class="level3">
<h3 class="anchored" data-anchor-id="returning-data-from-functions">Returning data from functions</h3>
<p>Functions must use r0 for data that fits in 32 bit (or less). This is, C types char, short, int, long (and float though we have not seen floating point yet) will be returned in r0. For basic types of 64 bit, like C types long long and double, they will be returned in r1 and r0. Any other data is returned through the stack unless it is 32 bit or less, where it will be returned in r0.</p>
</section>
<section id="hello-world-puts" class="level3">
<h3 class="anchored" data-anchor-id="hello-world-puts">Hello world (puts)</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb29-1"><a href="#cb29-1"></a>/* -- hello01<span class="op">.</span>s <span class="op">*/</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>.<span class="bu">data</span></span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="fu">greeting:</span></span>
<span id="cb29-5"><a href="#cb29-5"></a> .asciz <span class="st">"Hello world"</span></span>
<span id="cb29-6"><a href="#cb29-6"></a></span>
<span id="cb29-7"><a href="#cb29-7"></a>.balign <span class="dv">4</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="fu">return:</span> .<span class="dt">word</span> <span class="dv">0</span></span>
<span id="cb29-9"><a href="#cb29-9"></a></span>
<span id="cb29-10"><a href="#cb29-10"></a>.text</span>
<span id="cb29-11"><a href="#cb29-11"></a></span>
<span id="cb29-12"><a href="#cb29-12"></a>.global main</span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="fu">main:</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>    ldr r1<span class="op">,</span> address_of_return     <span class="op">/*</span>   r1 ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb29-15"><a href="#cb29-15"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                  <span class="op">/*</span>   <span class="op">*</span>r1 ← lr <span class="op">*/</span></span>
<span id="cb29-16"><a href="#cb29-16"></a></span>
<span id="cb29-17"><a href="#cb29-17"></a>    ldr r0<span class="op">,</span> address_of_greeting   <span class="op">/*</span> r0 ← <span class="op">&amp;</span>address_of_greeting <span class="op">*/</span></span>
<span id="cb29-18"><a href="#cb29-18"></a>                                  /* First parameter of puts <span class="op">*/</span></span>
<span id="cb29-19"><a href="#cb29-19"></a></span>
<span id="cb29-20"><a href="#cb29-20"></a>    bl puts                       <span class="op">/*</span> Call to puts <span class="op">*/</span></span>
<span id="cb29-21"><a href="#cb29-21"></a>                                  /* lr ← address of next instruction <span class="op">*/</span></span>
<span id="cb29-22"><a href="#cb29-22"></a></span>
<span id="cb29-23"><a href="#cb29-23"></a>    ldr r1<span class="op">,</span> address_of_return     <span class="op">/*</span> r1 ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb29-24"><a href="#cb29-24"></a>    ldr lr<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                  <span class="op">/*</span> lr ← <span class="op">*</span>r1 <span class="op">*/</span></span>
<span id="cb29-25"><a href="#cb29-25"></a>    bx lr                         <span class="op">/*</span> return from main <span class="op">*/</span></span>
<span id="cb29-26"><a href="#cb29-26"></a><span class="fu">address_of_greeting:</span> .<span class="dt">word</span> greeting</span>
<span id="cb29-27"><a href="#cb29-27"></a><span class="fu">address_of_return:</span> .<span class="dt">word</span> return</span>
<span id="cb29-28"><a href="#cb29-28"></a></span>
<span id="cb29-29"><a href="#cb29-29"></a>/* External <span class="op">*/</span></span>
<span id="cb29-30"><a href="#cb29-30"></a>.global puts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="interaction-scanf-printf" class="level3">
<h3 class="anchored" data-anchor-id="interaction-scanf-printf">Interaction (scanf, printf)</h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb30-1"><a href="#cb30-1"></a>/* -- printf01<span class="op">.</span>s <span class="op">*/</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>.<span class="bu">data</span></span>
<span id="cb30-3"><a href="#cb30-3"></a></span>
<span id="cb30-4"><a href="#cb30-4"></a>/* First message <span class="op">*/</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>.balign <span class="dv">4</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="fu">message1:</span> .asciz <span class="st">"Hey, type a number: "</span></span>
<span id="cb30-7"><a href="#cb30-7"></a></span>
<span id="cb30-8"><a href="#cb30-8"></a>/* Second message <span class="op">*/</span></span>
<span id="cb30-9"><a href="#cb30-9"></a>.balign <span class="dv">4</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="fu">message2:</span> .asciz <span class="st">"I read the number %d\n"</span></span>
<span id="cb30-11"><a href="#cb30-11"></a></span>
<span id="cb30-12"><a href="#cb30-12"></a>/* <span class="bu">Format</span> pattern for scanf <span class="op">*/</span></span>
<span id="cb30-13"><a href="#cb30-13"></a>.balign <span class="dv">4</span></span>
<span id="cb30-14"><a href="#cb30-14"></a>scan_pattern <span class="op">:</span> <span class="op">.</span>asciz <span class="st">"%d"</span></span>
<span id="cb30-15"><a href="#cb30-15"></a></span>
<span id="cb30-16"><a href="#cb30-16"></a>/* Where scanf will store the number read <span class="op">*/</span></span>
<span id="cb30-17"><a href="#cb30-17"></a>.balign <span class="dv">4</span></span>
<span id="cb30-18"><a href="#cb30-18"></a><span class="fu">number_read:</span> .<span class="dt">word</span> <span class="dv">0</span></span>
<span id="cb30-19"><a href="#cb30-19"></a></span>
<span id="cb30-20"><a href="#cb30-20"></a>.balign <span class="dv">4</span></span>
<span id="cb30-21"><a href="#cb30-21"></a><span class="fu">return:</span> .<span class="dt">word</span> <span class="dv">0</span></span>
<span id="cb30-22"><a href="#cb30-22"></a></span>
<span id="cb30-23"><a href="#cb30-23"></a>.text</span>
<span id="cb30-24"><a href="#cb30-24"></a></span>
<span id="cb30-25"><a href="#cb30-25"></a>.global main</span>
<span id="cb30-26"><a href="#cb30-26"></a><span class="fu">main:</span></span>
<span id="cb30-27"><a href="#cb30-27"></a>    ldr r1<span class="op">,</span> address_of_return        <span class="op">/*</span> r1 ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb30-28"><a href="#cb30-28"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                     <span class="op">/*</span> <span class="op">*</span>r1 ← lr <span class="op">*/</span></span>
<span id="cb30-29"><a href="#cb30-29"></a></span>
<span id="cb30-30"><a href="#cb30-30"></a>    ldr r0<span class="op">,</span> address_of_message1      <span class="op">/*</span> r0 ← <span class="op">&amp;</span>message1 <span class="op">*/</span></span>
<span id="cb30-31"><a href="#cb30-31"></a>    bl printf                        <span class="op">/*</span> call to printf <span class="op">*/</span></span>
<span id="cb30-32"><a href="#cb30-32"></a></span>
<span id="cb30-33"><a href="#cb30-33"></a>    ldr r0<span class="op">,</span> address_of_scan_pattern  <span class="op">/*</span> r0 ← <span class="op">&amp;</span>scan_pattern <span class="op">*/</span></span>
<span id="cb30-34"><a href="#cb30-34"></a>    ldr r1<span class="op">,</span> address_of_number_read   <span class="op">/*</span> r1 ← <span class="op">&amp;</span>number_read <span class="op">*/</span></span>
<span id="cb30-35"><a href="#cb30-35"></a>    bl scanf                         <span class="op">/*</span> call to scanf <span class="op">*/</span></span>
<span id="cb30-36"><a href="#cb30-36"></a></span>
<span id="cb30-37"><a href="#cb30-37"></a>    ldr r0<span class="op">,</span> address_of_message2      <span class="op">/*</span> r0 ← <span class="op">&amp;</span>message2 <span class="op">*/</span></span>
<span id="cb30-38"><a href="#cb30-38"></a>    ldr r1<span class="op">,</span> address_of_number_read   <span class="op">/*</span> r1 ← <span class="op">&amp;</span>number_read <span class="op">*/</span></span>
<span id="cb30-39"><a href="#cb30-39"></a>    ldr r1<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                     <span class="op">/*</span> r1 ← <span class="op">*</span>r1 <span class="op">*/</span></span>
<span id="cb30-40"><a href="#cb30-40"></a>    bl printf                        <span class="op">/*</span> call to printf <span class="op">*/</span></span>
<span id="cb30-41"><a href="#cb30-41"></a></span>
<span id="cb30-42"><a href="#cb30-42"></a>    ldr r0<span class="op">,</span> address_of_number_read   <span class="op">/*</span> r0 ← <span class="op">&amp;</span>number_read <span class="op">*/</span></span>
<span id="cb30-43"><a href="#cb30-43"></a>    ldr r0<span class="op">,</span> <span class="op">[</span>r0<span class="op">]</span>                     <span class="op">/*</span> r0 ← <span class="op">*</span>r0 <span class="op">*/</span></span>
<span id="cb30-44"><a href="#cb30-44"></a></span>
<span id="cb30-45"><a href="#cb30-45"></a>    ldr lr<span class="op">,</span> address_of_return        <span class="op">/*</span> lr ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb30-46"><a href="#cb30-46"></a>    ldr lr<span class="op">,</span> <span class="op">[</span>lr<span class="op">]</span>                     <span class="op">/*</span> lr ← <span class="op">*</span>lr <span class="op">*/</span></span>
<span id="cb30-47"><a href="#cb30-47"></a>    bx lr                            <span class="op">/*</span> return from main using lr <span class="op">*/</span></span>
<span id="cb30-48"><a href="#cb30-48"></a>address_of_message1 <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> message1</span>
<span id="cb30-49"><a href="#cb30-49"></a>address_of_message2 <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> message2</span>
<span id="cb30-50"><a href="#cb30-50"></a>address_of_scan_pattern <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> scan_pattern</span>
<span id="cb30-51"><a href="#cb30-51"></a>address_of_number_read <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> number_read</span>
<span id="cb30-52"><a href="#cb30-52"></a>address_of_return <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> return</span>
<span id="cb30-53"><a href="#cb30-53"></a></span>
<span id="cb30-54"><a href="#cb30-54"></a>/* External <span class="op">*/</span></span>
<span id="cb30-55"><a href="#cb30-55"></a>.global printf</span>
<span id="cb30-56"><a href="#cb30-56"></a>.global scanf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="first-function-multiply-by-5" class="level3">
<h3 class="anchored" data-anchor-id="first-function-multiply-by-5">First function (multiply by 5)</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb31-1"><a href="#cb31-1"></a>/* -- printf02<span class="op">.</span>s <span class="op">*/</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>.<span class="bu">data</span></span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a>/* First message <span class="op">*/</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>.balign <span class="dv">4</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="fu">message1:</span> .asciz <span class="st">"Hey, type a number: "</span></span>
<span id="cb31-7"><a href="#cb31-7"></a></span>
<span id="cb31-8"><a href="#cb31-8"></a>/* Second message <span class="op">*/</span></span>
<span id="cb31-9"><a href="#cb31-9"></a>.balign <span class="dv">4</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="fu">message2:</span> .asciz <span class="st">"%d times 5 is %d\n"</span></span>
<span id="cb31-11"><a href="#cb31-11"></a></span>
<span id="cb31-12"><a href="#cb31-12"></a>/* <span class="bu">Format</span> pattern for scanf <span class="op">*/</span></span>
<span id="cb31-13"><a href="#cb31-13"></a>.balign <span class="dv">4</span></span>
<span id="cb31-14"><a href="#cb31-14"></a>scan_pattern <span class="op">:</span> <span class="op">.</span>asciz <span class="st">"%d"</span></span>
<span id="cb31-15"><a href="#cb31-15"></a></span>
<span id="cb31-16"><a href="#cb31-16"></a>/* Where scanf will store the number read <span class="op">*/</span></span>
<span id="cb31-17"><a href="#cb31-17"></a>.balign <span class="dv">4</span></span>
<span id="cb31-18"><a href="#cb31-18"></a><span class="fu">number_read:</span> .<span class="dt">word</span> <span class="dv">0</span></span>
<span id="cb31-19"><a href="#cb31-19"></a></span>
<span id="cb31-20"><a href="#cb31-20"></a>.balign <span class="dv">4</span></span>
<span id="cb31-21"><a href="#cb31-21"></a><span class="fu">return:</span> .<span class="dt">word</span> <span class="dv">0</span></span>
<span id="cb31-22"><a href="#cb31-22"></a></span>
<span id="cb31-23"><a href="#cb31-23"></a>.balign <span class="dv">4</span></span>
<span id="cb31-24"><a href="#cb31-24"></a><span class="fu">return2:</span> .<span class="dt">word</span> <span class="dv">0</span></span>
<span id="cb31-25"><a href="#cb31-25"></a></span>
<span id="cb31-26"><a href="#cb31-26"></a>.text</span>
<span id="cb31-27"><a href="#cb31-27"></a></span>
<span id="cb31-28"><a href="#cb31-28"></a>/*</span>
<span id="cb31-29"><a href="#cb31-29"></a>mult_by_5 function</span>
<span id="cb31-30"><a href="#cb31-30"></a>*/</span>
<span id="cb31-31"><a href="#cb31-31"></a><span class="fu">mult_by_5:</span> </span>
<span id="cb31-32"><a href="#cb31-32"></a>    ldr r1<span class="op">,</span> address_of_return2       <span class="op">/*</span> r1 ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb31-33"><a href="#cb31-33"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                     <span class="op">/*</span> <span class="op">*</span>r1 ← lr <span class="op">*/</span></span>
<span id="cb31-34"><a href="#cb31-34"></a></span>
<span id="cb31-35"><a href="#cb31-35"></a>    <span class="bu">add</span> r0<span class="op">,</span> r0<span class="op">,</span> r0<span class="op">,</span> LSL <span class="op">#</span><span class="dv">2</span>           <span class="op">/*</span> r0 ← r0 <span class="op">+</span> <span class="dv">4</span><span class="op">*</span>r0 <span class="op">*/</span></span>
<span id="cb31-36"><a href="#cb31-36"></a></span>
<span id="cb31-37"><a href="#cb31-37"></a>    ldr lr<span class="op">,</span> address_of_return2       <span class="op">/*</span> lr ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb31-38"><a href="#cb31-38"></a>    ldr lr<span class="op">,</span> <span class="op">[</span>lr<span class="op">]</span>                     <span class="op">/*</span> lr ← <span class="op">*</span>lr <span class="op">*/</span></span>
<span id="cb31-39"><a href="#cb31-39"></a>    bx lr                            <span class="op">/*</span> return from main using lr <span class="op">*/</span></span>
<span id="cb31-40"><a href="#cb31-40"></a>address_of_return2 <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> return2</span>
<span id="cb31-41"><a href="#cb31-41"></a></span>
<span id="cb31-42"><a href="#cb31-42"></a>.global main</span>
<span id="cb31-43"><a href="#cb31-43"></a><span class="fu">main:</span></span>
<span id="cb31-44"><a href="#cb31-44"></a>    ldr r1<span class="op">,</span> address_of_return        <span class="op">/*</span> r1 ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb31-45"><a href="#cb31-45"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                     <span class="op">/*</span> <span class="op">*</span>r1 ← lr <span class="op">*/</span></span>
<span id="cb31-46"><a href="#cb31-46"></a></span>
<span id="cb31-47"><a href="#cb31-47"></a>    ldr r0<span class="op">,</span> address_of_message1      <span class="op">/*</span> r0 ← <span class="op">&amp;</span>message1 <span class="op">*/</span></span>
<span id="cb31-48"><a href="#cb31-48"></a>    bl printf                        <span class="op">/*</span> call to printf <span class="op">*/</span></span>
<span id="cb31-49"><a href="#cb31-49"></a></span>
<span id="cb31-50"><a href="#cb31-50"></a>    ldr r0<span class="op">,</span> address_of_scan_pattern  <span class="op">/*</span> r0 ← <span class="op">&amp;</span>scan_pattern <span class="op">*/</span></span>
<span id="cb31-51"><a href="#cb31-51"></a>    ldr r1<span class="op">,</span> address_of_number_read   <span class="op">/*</span> r1 ← <span class="op">&amp;</span>number_read <span class="op">*/</span></span>
<span id="cb31-52"><a href="#cb31-52"></a>    bl scanf                         <span class="op">/*</span> call to scanf <span class="op">*/</span></span>
<span id="cb31-53"><a href="#cb31-53"></a></span>
<span id="cb31-54"><a href="#cb31-54"></a>    ldr r0<span class="op">,</span> address_of_number_read   <span class="op">/*</span> r0 ← <span class="op">&amp;</span>number_read <span class="op">*/</span></span>
<span id="cb31-55"><a href="#cb31-55"></a>    ldr r0<span class="op">,</span> <span class="op">[</span>r0<span class="op">]</span>                     <span class="op">/*</span> r0 ← <span class="op">*</span>r0 <span class="op">*/</span></span>
<span id="cb31-56"><a href="#cb31-56"></a>    bl mult_by_5</span>
<span id="cb31-57"><a href="#cb31-57"></a></span>
<span id="cb31-58"><a href="#cb31-58"></a>    <span class="bu">mov</span> r2<span class="op">,</span> r0                       <span class="op">/*</span> r2 ← r0 <span class="op">*/</span></span>
<span id="cb31-59"><a href="#cb31-59"></a>    ldr r1<span class="op">,</span> address_of_number_read   <span class="op">/*</span> r1 ← <span class="op">&amp;</span>number_read <span class="op">*/</span></span>
<span id="cb31-60"><a href="#cb31-60"></a>    ldr r1<span class="op">,</span> <span class="op">[</span>r1<span class="op">]</span>                     <span class="op">/*</span> r1 ← <span class="op">*</span>r1 <span class="op">*/</span></span>
<span id="cb31-61"><a href="#cb31-61"></a>    ldr r0<span class="op">,</span> address_of_message2      <span class="op">/*</span> r0 ← <span class="op">&amp;</span>message2 <span class="op">*/</span></span>
<span id="cb31-62"><a href="#cb31-62"></a>    bl printf                        <span class="op">/*</span> call to printf <span class="op">*/</span></span>
<span id="cb31-63"><a href="#cb31-63"></a></span>
<span id="cb31-64"><a href="#cb31-64"></a>    ldr lr<span class="op">,</span> address_of_return        <span class="op">/*</span> lr ← <span class="op">&amp;</span>address_of_return <span class="op">*/</span></span>
<span id="cb31-65"><a href="#cb31-65"></a>    ldr lr<span class="op">,</span> <span class="op">[</span>lr<span class="op">]</span>                     <span class="op">/*</span> lr ← <span class="op">*</span>lr <span class="op">*/</span></span>
<span id="cb31-66"><a href="#cb31-66"></a>    bx lr                            <span class="op">/*</span> return from main using lr <span class="op">*/</span></span>
<span id="cb31-67"><a href="#cb31-67"></a>address_of_message1 <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> message1</span>
<span id="cb31-68"><a href="#cb31-68"></a>address_of_message2 <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> message2</span>
<span id="cb31-69"><a href="#cb31-69"></a>address_of_scan_pattern <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> scan_pattern</span>
<span id="cb31-70"><a href="#cb31-70"></a>address_of_number_read <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> number_read</span>
<span id="cb31-71"><a href="#cb31-71"></a>address_of_return <span class="op">:</span> <span class="op">.</span><span class="dt">word</span> return</span>
<span id="cb31-72"><a href="#cb31-72"></a></span>
<span id="cb31-73"><a href="#cb31-73"></a>/* External <span class="op">*/</span></span>
<span id="cb31-74"><a href="#cb31-74"></a>.global printf</span>
<span id="cb31-75"><a href="#cb31-75"></a>.global scanf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="functions.-the-stack" class="level2">
<h2 class="anchored" data-anchor-id="functions.-the-stack">10 Functions. The stack</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb32-1"><a href="#cb32-1"></a>// stm <span class="op">--</span> store multiple<span class="op">,</span> i <span class="op">--</span> increase<span class="op">,</span> a <span class="op">--</span> after<span class="op">,</span> d <span class="op">--</span> decrease<span class="op">,</span> b <span class="op">--</span> before </span>
<span id="cb32-2"><a href="#cb32-2"></a>stmia<span class="op">,</span> stmib<span class="op">,</span> stmda<span class="op">,</span> stmdb<span class="op">,</span> ldmia<span class="op">,</span> ldmib<span class="op">,</span> ldmda<span class="op">,</span> ldmdb </span>
<span id="cb32-3"><a href="#cb32-3"></a></span>
<span id="cb32-4"><a href="#cb32-4"></a>// <span class="bu">push</span> is equivalent to stmdb<span class="op">,</span> pop is equivalent to ldmia when operating on <span class="kw">sp</span> </span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="bu">push</span><span class="op">,</span> pop</span>
<span id="cb32-6"><a href="#cb32-6"></a></span>
<span id="cb32-7"><a href="#cb32-7"></a>// multiplication instruction </span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="bu">mul</span> Rdest<span class="op">,</span> Rsource1<span class="op">,</span> Rsource2<span class="op">.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="dynamic-activation" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-activation">Dynamic activation</h3>
<p>One of the benefits of functions is being able to call them more than once. A function may call itself.</p>
<p>A function is dynamically activated each time it is called. The span of a dynamic activation goes from the point where the function is called until it returns. At a given time, more than one function is dynamically activated. The whole dynamic activation set of functions includes the current function and the dynamic activation set of the function that called it (the current function).</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource c number-lines code-with-copy"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1"></a><span class="co">//Example recursive function that calls itself </span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="dt">int</span> factorial<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="op">{</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>   <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>      <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>   <span class="cf">else</span></span>
<span id="cb33-7"><a href="#cb33-7"></a>      <span class="cf">return</span> n <span class="op">*</span> factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Well behaved functions(Refer to Chap9), a brief recall:</p>
<ul>
<li>Only r0, r1, r2 and r3 can be freely modified.</li>
<li>lr(r14) value at the entry of the function must be kept somewhere because we will need it to leave the function (to return to the caller).</li>
<li>All other registers r4 to r11 and sp(r13) can be modified but they must be restored to their original values upon leaving the function.</li>
</ul>
<p>Note: pc register is r15. TBD: What’s the function of r12 function? Why is it not mentioned here?</p>
<p>we need some way to keep at least the value of lr per each dynamic activation. And not only lr, if we wanted to use registers from r4 to r11 we also need to keep somehow per each dynamic activation, a global variable would not be enough either. This is where the stack comes into play.</p>
</section>
<section id="the-stack" class="level3">
<h3 class="anchored" data-anchor-id="the-stack">The stack</h3>
<p>In computing, a stack is a data structure (a way to organize data that provides some interesting properties). A stack typically has three operations: access the top of the stack, push onto the top, pop from the top. Dependening on the context you can only access the top of the stack, in our case we will be able to access more elements than just the top.</p>
<p>But, what is the stack? I already said in chaper 9 that the stack is a region of memory owned solely by the function. We can now reword this a bit better: the stack is a region of memory owned solely by the current dynamic activation. register sp stands for stack pointer. This register will contain the top of the stack. The region of memory owned by the dynamic activation is the extent of bytes contained between the current value of sp and the initial value that sp had at the beginning of the function. We will call that region the local memory of a function (more precisely, of a dynamic activation of it). We will put there whatever has to be saved at the beginning of a function and restored before leaving. We will also keep there the local variables of a function (dynamic activation).</p>
<p>Our function also has to adhere to some rules when handling the stack.</p>
<ul>
<li>The stack pointer (sp) is always 4 byte aligned. This is absolutely mandatory. However, due to the Procedure Call Standard for the ARM architecture (AAPCS), the stack pointer will have to be 8 byte aligned, otherwise funny things may happen when we call what the AAPCS calls as public interfaces (this is, code written by other people). (Note: It means we can persist in 4 byte aligned if the function we are written is only called by ourself, and we won’t call functions written by other persons; otherwise, we should persist in 8 byte algined.)<br>
</li>
<li>The value of sp when leaving the function should be the same value it had upon entering the function.</li>
</ul>
<p>It is a convention how the stack, and thus the local memory, has its size defined. The stack can grow upwards or downwards. If it grows upwards it means that we have to increase the value of the sp register in order to enlarge the local memory. If it grows downwards we have to do the opposite, the value of the sp register must be subtracted as many bytes as the size of the local storage. In Linux ARM, the stack grows downwards, towards zero (although it never should reach zero). Addresses of local variables have very large values in the 32 bit range. They are usually close to <span class="math inline">\(2^{32}\)</span>.</p>
<p>Another convention when using the stack concerns whether the sp register contains the address of the top of the stack or some bytes above. In Linux ARM the sp register directly points to the top of the stack: in the memory addressed by sp there is useful information.</p>
<p>Example snippets of keep <code>lr</code> register and restore <code>lr</code> register. (Note: We can use add and sub to operate sp, we may also use push and pop or stmxx and ldmxx instructions.)</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb34-1"><a href="#cb34-1"></a><span class="bu">sub</span> <span class="kw">sp</span><span class="op">,</span> <span class="kw">sp</span><span class="op">,</span> <span class="op">#</span><span class="dv">8</span>  <span class="op">/*</span> <span class="kw">sp</span> ← <span class="kw">sp</span> <span class="op">-</span> <span class="fl">8.</span> This enlarges the stack by <span class="dv">8</span> bytes <span class="op">*/</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">]</span>    <span class="op">/*</span> <span class="op">*</span><span class="kw">sp</span> ← lr <span class="op">*/</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>... // Code of the function</span>
<span id="cb34-4"><a href="#cb34-4"></a>ldr lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">]</span>    <span class="op">/*</span> lr ← <span class="op">*</span><span class="kw">sp</span> <span class="op">*/</span></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="bu">add</span> <span class="kw">sp</span><span class="op">,</span> <span class="kw">sp</span><span class="op">,</span> <span class="op">#</span><span class="dv">8</span>  <span class="op">/*</span> <span class="kw">sp</span> ← <span class="kw">sp</span> <span class="op">+</span> <span class="fl">8.</span> <span class="op">/*</span> This reduces the stack by <span class="dv">8</span> bytes</span>
<span id="cb34-6"><a href="#cb34-6"></a>                                effectively restoring the stack </span>
<span id="cb34-7"><a href="#cb34-7"></a>                                pointer to its original value <span class="op">*/</span></span>
<span id="cb34-8"><a href="#cb34-8"></a>bx lr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Shortened snippets of keep <code>lr</code> and restore <code>lr</code>, making use of indexing modes.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb35-1"><a href="#cb35-1"></a><span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">,</span> <span class="op">#-</span><span class="dv">8</span><span class="op">]!</span>  <span class="op">/*</span> preindex<span class="op">:</span> <span class="kw">sp</span> ← <span class="kw">sp</span> <span class="op">-</span> <span class="dv">8</span><span class="co">; *sp ← lr */</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>... // Code of the function</span>
<span id="cb35-3"><a href="#cb35-3"></a>ldr lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">],</span> <span class="op">#+</span><span class="dv">8</span>   <span class="op">/*</span> postindex<span class="co">; lr ← *sp; sp ← sp + 8 */</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>bx lr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="first-approach-to-implement-the-factorial-function" class="level3">
<h3 class="anchored" data-anchor-id="first-approach-to-implement-the-factorial-function">First approach to implement the factorial function</h3>
<p>It uses the <code>mul Rdest, Rsource1, Rsource2</code> instruction.</p>
<p>This instruction only computes the lower 32 bits. Because we are not going to use 64 bit values in this example, the maximum factorial we will be able to compute is 12! (13! is bigger than <span class="math inline">\(2^{32}\)</span>).</p>
<p>This approach directly operates on the <code>sp</code> register.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb36-1"><a href="#cb36-1"></a>/* -- factorial01<span class="op">.</span>s <span class="op">*/</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>.<span class="bu">data</span></span>
<span id="cb36-3"><a href="#cb36-3"></a></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="fu">message1:</span> .asciz <span class="st">"Type a number: "</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="fu">format:</span>   .asciz <span class="st">"%d"</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="fu">message2:</span> .asciz <span class="st">"The factorial of %d is %d\n"</span></span>
<span id="cb36-7"><a href="#cb36-7"></a></span>
<span id="cb36-8"><a href="#cb36-8"></a>.text</span>
<span id="cb36-9"><a href="#cb36-9"></a></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="fu">factorial:</span></span>
<span id="cb36-11"><a href="#cb36-11"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">,#-</span><span class="dv">4</span><span class="op">]!</span>  <span class="op">/*</span> Push lr onto the top of the stack <span class="op">*/</span></span>
<span id="cb36-12"><a href="#cb36-12"></a>    <span class="bu">str</span> r0<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">,#-</span><span class="dv">4</span><span class="op">]!</span>  <span class="op">/*</span> Push r0 onto the top of the stack <span class="op">*/</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>                       /* Note that after that<span class="op">,</span> <span class="kw">sp</span> is <span class="dv">8</span> <span class="dt">byte</span> aligned <span class="op">*/</span></span>
<span id="cb36-14"><a href="#cb36-14"></a>    <span class="bu">cmp</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">0</span>         <span class="op">/*</span> compare r0 <span class="op">and</span> <span class="dv">0</span> <span class="op">*/</span></span>
<span id="cb36-15"><a href="#cb36-15"></a>    bne is_nonzero     <span class="op">/*</span> if r0 <span class="op">!=</span> <span class="dv">0</span> then branch <span class="op">*/</span></span>
<span id="cb36-16"><a href="#cb36-16"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>         <span class="op">/*</span> r0 ← <span class="fl">1.</span> This is the return <span class="op">*/</span></span>
<span id="cb36-17"><a href="#cb36-17"></a>    b end</span>
<span id="cb36-18"><a href="#cb36-18"></a><span class="fu">is_nonzero:</span></span>
<span id="cb36-19"><a href="#cb36-19"></a>                       /* Prepare the call to factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>    <span class="bu">sub</span> r0<span class="op">,</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>     <span class="op">/*</span> r0 ← r0 <span class="op">-</span> <span class="dv">1</span> <span class="op">*/</span></span>
<span id="cb36-21"><a href="#cb36-21"></a>    bl factorial</span>
<span id="cb36-22"><a href="#cb36-22"></a>                       /* After the call r0 contains factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb36-23"><a href="#cb36-23"></a>                       /* <span class="bu">Load</span> r0 <span class="op">(</span>that we kept in th stack<span class="op">)</span> into r1 <span class="op">*/</span></span>
<span id="cb36-24"><a href="#cb36-24"></a>    ldr r1<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">]</span>       <span class="op">/*</span> r1 ← <span class="op">*</span><span class="kw">sp</span> <span class="op">*/</span></span>
<span id="cb36-25"><a href="#cb36-25"></a>    <span class="bu">mul</span> r0<span class="op">,</span> r0<span class="op">,</span> r1     <span class="op">/*</span> r0 ← r0 <span class="op">*</span> r1 <span class="op">*/</span></span>
<span id="cb36-26"><a href="#cb36-26"></a>    </span>
<span id="cb36-27"><a href="#cb36-27"></a><span class="fu">end:</span></span>
<span id="cb36-28"><a href="#cb36-28"></a>    <span class="bu">add</span> <span class="kw">sp</span><span class="op">,</span> <span class="kw">sp</span><span class="op">,</span> <span class="op">#+</span><span class="dv">4</span>    <span class="op">/*</span> Discard the r0 we kept in the stack <span class="op">*/</span></span>
<span id="cb36-29"><a href="#cb36-29"></a>    ldr lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">],</span> <span class="op">#+</span><span class="dv">4</span>  <span class="op">/*</span> Pop the top of the stack <span class="op">and</span> put it in lr <span class="op">*/</span></span>
<span id="cb36-30"><a href="#cb36-30"></a>    bx lr              <span class="op">/*</span> Leave factorial <span class="op">*/</span></span>
<span id="cb36-31"><a href="#cb36-31"></a></span>
<span id="cb36-32"><a href="#cb36-32"></a>.global main</span>
<span id="cb36-33"><a href="#cb36-33"></a><span class="fu">main:</span></span>
<span id="cb36-34"><a href="#cb36-34"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">,#-</span><span class="dv">4</span><span class="op">]!</span>            <span class="op">/*</span> Push lr onto the top of the stack <span class="op">*/</span></span>
<span id="cb36-35"><a href="#cb36-35"></a>    <span class="bu">sub</span> <span class="kw">sp</span><span class="op">,</span> <span class="kw">sp</span><span class="op">,</span> <span class="op">#</span><span class="dv">4</span>               <span class="op">/*</span> Make room for one <span class="dv">4</span> <span class="dt">byte</span> integer in the stack <span class="op">*/</span></span>
<span id="cb36-36"><a href="#cb36-36"></a>                                 /* <span class="bu">In</span> these <span class="dv">4</span> bytes we will keep the number <span class="op">*/</span></span>
<span id="cb36-37"><a href="#cb36-37"></a>                                 /* entered by the user <span class="op">*/</span></span>
<span id="cb36-38"><a href="#cb36-38"></a>                                 /* Note that after that the stack is <span class="dv">8</span><span class="op">-</span><span class="dt">byte</span> aligned <span class="op">*/</span></span>
<span id="cb36-39"><a href="#cb36-39"></a>    ldr r0<span class="op">,</span> address_of_message1  <span class="op">/*</span> Set <span class="op">&amp;</span>message1 as the first parameter of printf <span class="op">*/</span></span>
<span id="cb36-40"><a href="#cb36-40"></a>    bl printf                    <span class="op">/*</span> Call printf <span class="op">*/</span></span>
<span id="cb36-41"><a href="#cb36-41"></a></span>
<span id="cb36-42"><a href="#cb36-42"></a>    ldr r0<span class="op">,</span> address_of_format    <span class="op">/*</span> Set <span class="op">&amp;</span>format as the first parameter of scanf <span class="op">*/</span></span>
<span id="cb36-43"><a href="#cb36-43"></a>    <span class="bu">mov</span> r1<span class="op">,</span> <span class="kw">sp</span>                   <span class="op">/*</span> Set the top of the stack as the second parameter <span class="op">*/</span></span>
<span id="cb36-44"><a href="#cb36-44"></a>                                 /* of scanf <span class="op">*/</span></span>
<span id="cb36-45"><a href="#cb36-45"></a>    bl scanf                     <span class="op">/*</span> Call scanf <span class="op">*/</span></span>
<span id="cb36-46"><a href="#cb36-46"></a></span>
<span id="cb36-47"><a href="#cb36-47"></a>    ldr r0<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">]</span>                 <span class="op">/*</span> Load the integer read by scanf into r0 <span class="op">*/</span></span>
<span id="cb36-48"><a href="#cb36-48"></a>                                 /* So we set it as the first parameter of factorial <span class="op">*/</span></span>
<span id="cb36-49"><a href="#cb36-49"></a>    bl factorial                 <span class="op">/*</span> Call factorial <span class="op">*/</span></span>
<span id="cb36-50"><a href="#cb36-50"></a></span>
<span id="cb36-51"><a href="#cb36-51"></a>    <span class="bu">mov</span> r2<span class="op">,</span> r0                   <span class="op">/*</span> Get the result of factorial <span class="op">and</span> move it to r2 <span class="op">*/</span></span>
<span id="cb36-52"><a href="#cb36-52"></a>                                 /* So we set it as the third parameter of printf <span class="op">*/</span></span>
<span id="cb36-53"><a href="#cb36-53"></a>    ldr r1<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">]</span>                 <span class="op">/*</span> Load the integer read by scanf into r1 <span class="op">*/</span></span>
<span id="cb36-54"><a href="#cb36-54"></a>                                 /* So we set it as the second parameter of printf <span class="op">*/</span></span>
<span id="cb36-55"><a href="#cb36-55"></a>    ldr r0<span class="op">,</span> address_of_message2  <span class="op">/*</span> Set <span class="op">&amp;</span>message2 as the first parameter of printf <span class="op">*/</span></span>
<span id="cb36-56"><a href="#cb36-56"></a>    bl printf                    <span class="op">/*</span> Call printf <span class="op">*/</span></span>
<span id="cb36-57"><a href="#cb36-57"></a></span>
<span id="cb36-58"><a href="#cb36-58"></a></span>
<span id="cb36-59"><a href="#cb36-59"></a>    <span class="bu">add</span> <span class="kw">sp</span><span class="op">,</span> <span class="kw">sp</span><span class="op">,</span> <span class="op">#+</span><span class="dv">4</span>              <span class="op">/*</span> Discard the integer read by scanf <span class="op">*/</span></span>
<span id="cb36-60"><a href="#cb36-60"></a>    ldr lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">],</span> <span class="op">#+</span><span class="dv">4</span>            <span class="op">/*</span> Pop the top of the stack <span class="op">and</span> put it in lr <span class="op">*/</span></span>
<span id="cb36-61"><a href="#cb36-61"></a>    bx lr                        <span class="op">/*</span> Leave main <span class="op">*/</span></span>
<span id="cb36-62"><a href="#cb36-62"></a></span>
<span id="cb36-63"><a href="#cb36-63"></a><span class="fu">address_of_message1:</span> .<span class="dt">word</span> message1</span>
<span id="cb36-64"><a href="#cb36-64"></a><span class="fu">address_of_message2:</span> .<span class="dt">word</span> message2</span>
<span id="cb36-65"><a href="#cb36-65"></a><span class="fu">address_of_format:</span> .<span class="dt">word</span> format</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="do-it-better-using-ldm-and-stm" class="level3">
<h3 class="anchored" data-anchor-id="do-it-better-using-ldm-and-stm">Do it better using <code>ldm</code> and <code>stm</code></h3>
<p>Note that the number of instructions that we need to push and pop data to and from the stack grows linearly with respect to the number of data items. Since ARM was designed for embedded systems, ARM designers devised a way to reduce the number of instructions we need for the «bookkeeping» of the stack. These instructions are load multiple, ldm, and store multiple, stm.</p>
<p>These two instructions are rather powerful and allow in a single instruction perform a lot of things. Their syntax is shown as follows. Elements enclosed in curly braces { and } may be omitted from the syntax (the effect of the instruction will vary, though).</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb37-1"><a href="#cb37-1"></a>ldm addressing<span class="op">-</span>mode Rbase<span class="op">{!},</span> register<span class="op">-</span>set</span>
<span id="cb37-2"><a href="#cb37-2"></a>stm addressing<span class="op">-</span>mode Rbase<span class="op">{!},</span> register<span class="op">-</span>set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will consider addressing-mode later. Rbase is the base address used to load to or store from the register-set. All 16 ARM registers may be specified in register-set (except pc in stm). A set of addresses is generated when executing these instructions. One address per register in the register-set. Then, each register, in ascending order, is paired with each of these addresses, also in ascending order. This way the lowest-numbered register gets the lowest memory address, and the highest-numbered register gets the highest memory address. Each pair register-address is then used to perform the memory operation: load or store. Specifying ! means that Rbase will be updated. The updated value depends on addressing-mode.</p>
<p>Note that, if the registers are paired with addresses depending on their register number, it seems that they will always be loaded and stored in the same way. For instance a register-set containing r4, r5 and r6 will always store r4 in the lowest address generated by the instruction and r6 in the highest one(Note: Since it is a set, the order does not matter. <code>r4, r5, r6</code> and <code>r4, r6, r5</code> mean the same thing in a set). We can, though, specify what is considered the lowest address or the highest address. So, is Rbase actually the highest address or the lowest address of the multiple load/store? This is one of the two aspects that is controlled by addressing-mode. The second aspect relates to when the address of the memory operation changes between each memory operation.</p>
<p>If the value in Rbase is to be considered the the highest address it means that we should first decrease Rbase as many bytes as required by the number of registers in the register-set (this is 4 times the number of registers) to form the lowest address. Then we can load or store each register consecutively starting from that lowest address, always in ascending order of the register number. This addressing mode is called decreasing and is specified using a <code>d</code>. Conversely, if Rbase is to be considered the lowest address, then this is a bit easier as we can use its value as the lowest address already. We proceed as usual, loading or storing each register in ascending order of their register number. This addressing mode is called increasing and is specified using an <code>i</code>.</p>
<p>At each load or store, the address generated for the memory operation may be updated after or before the memory operation itself. We can specify this using <code>a</code> or <code>b</code>, respectively.</p>
<p>If we specify !, after the instruction, Rbase will have the highest address generated in the increasing mode and the lowest address generated in the decreasing mode. The final value of Rbase will include the final addition or subtraction if we use a mode that updates after (an a mode).</p>
<p>So we have four addressing modes, namely: ia, ib, da and db. These addressing modes are specified as suffixes of the stm and ldm instructions. So the full set of names is stmia, stmib, stmda, stmdb, ldmia, ldmib, ldmda, ldmdb. Now you may think that this is overly complicated, but we need not use all the eight modes. Only two of them are of interest to us now.</p>
<p>When we push something onto the stack we actually decrease the stack pointer (because in Linux the stack grows downwards). More precisely, we first decrease the stack pointer as many bytes as needed before doing the actual store on that just computed stack pointer. So the appropiate addressing-mode when pushing onto the stack is stmdb. Conversely when popping from the stack we will use ldmia: we increment the stack pointer after we have performed the load.</p>
</section>
<section id="factorial-again-using-stm-or-push-and-ldm-or-pop" class="level3">
<h3 class="anchored" data-anchor-id="factorial-again-using-stm-or-push-and-ldm-or-pop">Factorial again using <code>stm or push</code> and <code>ldm or pop</code></h3>
<p>Before illustrating these two instructions, we will first slightly rewrite our factorial.</p>
<p>If you go back to the code of our factorial, there is a moment, when computing n * factorial(n-1), where the initial value of r0 is required. The value of n was in r0 at the beginning of the function, but r0 can be freely modified by called functions.</p>
<p>In our second version of factorial, we will keep a copy of the initial value of r0 into r4. But r4 is a register the value of which must be restored upon leaving a function. So we will keep the value of r4 at the entry of the function in the stack. At the end we will restore it back from the stack. This way we can use r4 without breaking the rules of well-behaved functions.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb38-1"><a href="#cb38-1"></a><span class="fu">factorial:</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>    <span class="bu">str</span> lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">,#-</span><span class="dv">4</span><span class="op">]!</span>  <span class="op">/*</span> Push lr onto the top of the stack <span class="op">*/</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="bu">str</span> r4<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">,#-</span><span class="dv">4</span><span class="op">]!</span>  <span class="op">/*</span> Push r4 onto the top of the stack <span class="op">*/</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>                       /* The stack is now <span class="dv">8</span> <span class="dt">byte</span> aligned <span class="op">*/</span></span>
<span id="cb38-5"><a href="#cb38-5"></a>    <span class="bu">mov</span> r4<span class="op">,</span> r0         <span class="op">/*</span> Keep a copy of the initial value of r0 in r4 <span class="op">*/</span></span>
<span id="cb38-6"><a href="#cb38-6"></a></span>
<span id="cb38-7"><a href="#cb38-7"></a></span>
<span id="cb38-8"><a href="#cb38-8"></a>    <span class="bu">cmp</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">0</span>         <span class="op">/*</span> compare r0 <span class="op">and</span> <span class="dv">0</span> <span class="op">*/</span></span>
<span id="cb38-9"><a href="#cb38-9"></a>    bne is_nonzero     <span class="op">/*</span> if r0 <span class="op">!=</span> <span class="dv">0</span> then branch <span class="op">*/</span></span>
<span id="cb38-10"><a href="#cb38-10"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>         <span class="op">/*</span> r0 ← <span class="fl">1.</span> This is the return <span class="op">*/</span></span>
<span id="cb38-11"><a href="#cb38-11"></a>    b end</span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="fu">is_nonzero:</span></span>
<span id="cb38-13"><a href="#cb38-13"></a>                       /* Prepare the call to factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb38-14"><a href="#cb38-14"></a>    <span class="bu">sub</span> r0<span class="op">,</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>     <span class="op">/*</span> r0 ← r0 <span class="op">-</span> <span class="dv">1</span> <span class="op">*/</span></span>
<span id="cb38-15"><a href="#cb38-15"></a>    bl factorial</span>
<span id="cb38-16"><a href="#cb38-16"></a>                       /* After the call r0 contains factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb38-17"><a href="#cb38-17"></a>                       /* <span class="bu">Load</span> initial value of r0 <span class="op">(</span>that we kept in r4<span class="op">)</span> into r1 <span class="op">*/</span></span>
<span id="cb38-18"><a href="#cb38-18"></a>    <span class="bu">mov</span> r1<span class="op">,</span> r4         <span class="op">/*</span> r1 ← r4 <span class="op">*/</span></span>
<span id="cb38-19"><a href="#cb38-19"></a>    <span class="bu">mul</span> r0<span class="op">,</span> r0<span class="op">,</span> r1     <span class="op">/*</span> r0 ← r0 <span class="op">*</span> r1 <span class="op">*/</span></span>
<span id="cb38-20"><a href="#cb38-20"></a></span>
<span id="cb38-21"><a href="#cb38-21"></a><span class="fu">end:</span></span>
<span id="cb38-22"><a href="#cb38-22"></a>    ldr r4<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">],</span> <span class="op">#+</span><span class="dv">4</span>  <span class="op">/*</span> Pop the top of the stack <span class="op">and</span> put it in r4 <span class="op">*/</span></span>
<span id="cb38-23"><a href="#cb38-23"></a>    ldr lr<span class="op">,</span> <span class="op">[</span><span class="kw">sp</span><span class="op">],</span> <span class="op">#+</span><span class="dv">4</span>  <span class="op">/*</span> Pop the top of the stack <span class="op">and</span> put it in lr <span class="op">*/</span></span>
<span id="cb38-24"><a href="#cb38-24"></a>    bx lr              <span class="op">/*</span> Leave factorial <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The above program can be improved via <code>stmdb</code> and <code>ldmia</code> as below:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">factorial:</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>    stmdb <span class="kw">sp</span><span class="op">!,</span> <span class="op">{</span>r4<span class="op">,</span> lr<span class="op">}</span> <span class="op">/*</span> Push r4 <span class="op">and</span> lr onto the stack <span class="op">*/</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>     </span>
<span id="cb39-4"><a href="#cb39-4"></a>                       /* The stack is now <span class="dv">8</span> <span class="dt">byte</span> aligned <span class="op">*/</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>    <span class="bu">mov</span> r4<span class="op">,</span> r0         <span class="op">/*</span> Keep a copy of the initial value of r0 in r4 <span class="op">*/</span></span>
<span id="cb39-6"><a href="#cb39-6"></a></span>
<span id="cb39-7"><a href="#cb39-7"></a></span>
<span id="cb39-8"><a href="#cb39-8"></a>    <span class="bu">cmp</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">0</span>         <span class="op">/*</span> compare r0 <span class="op">and</span> <span class="dv">0</span> <span class="op">*/</span></span>
<span id="cb39-9"><a href="#cb39-9"></a>    bne is_nonzero     <span class="op">/*</span> if r0 <span class="op">!=</span> <span class="dv">0</span> then branch <span class="op">*/</span></span>
<span id="cb39-10"><a href="#cb39-10"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>         <span class="op">/*</span> r0 ← <span class="fl">1.</span> This is the return <span class="op">*/</span></span>
<span id="cb39-11"><a href="#cb39-11"></a>    b end</span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="fu">is_nonzero:</span></span>
<span id="cb39-13"><a href="#cb39-13"></a>                       /* Prepare the call to factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb39-14"><a href="#cb39-14"></a>    <span class="bu">sub</span> r0<span class="op">,</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>     <span class="op">/*</span> r0 ← r0 <span class="op">-</span> <span class="dv">1</span> <span class="op">*/</span></span>
<span id="cb39-15"><a href="#cb39-15"></a>    bl factorial</span>
<span id="cb39-16"><a href="#cb39-16"></a>                       /* After the call r0 contains factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb39-17"><a href="#cb39-17"></a>                       /* <span class="bu">Load</span> initial value of r0 <span class="op">(</span>that we kept in r4<span class="op">)</span> into r1 <span class="op">*/</span></span>
<span id="cb39-18"><a href="#cb39-18"></a>    <span class="bu">mov</span> r1<span class="op">,</span> r4         <span class="op">/*</span> r1 ← r4 <span class="op">*/</span></span>
<span id="cb39-19"><a href="#cb39-19"></a>    <span class="bu">mul</span> r0<span class="op">,</span> r0<span class="op">,</span> r1     <span class="op">/*</span> r0 ← r0 <span class="op">*</span> r1 <span class="op">*/</span></span>
<span id="cb39-20"><a href="#cb39-20"></a></span>
<span id="cb39-21"><a href="#cb39-21"></a><span class="fu">end:</span></span>
<span id="cb39-22"><a href="#cb39-22"></a>    ldmia <span class="kw">sp</span><span class="op">!,</span> <span class="op">{</span>r4<span class="op">,</span> lr<span class="op">}</span>    <span class="op">/*</span> Pop lr <span class="op">and</span> r4 from the stack <span class="op">*/</span></span>
<span id="cb39-23"><a href="#cb39-23"></a>    bx lr              <span class="op">/*</span> Leave factorial <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that the order of the registers in the set of registers is not relevant(the order of elements in a set does not matter), but the processor will handle them in ascending order, so we should write them in ascending order. GNU assembler will emit a warning otherwise. Since lr is actually r14 it must go after r4. This means that our code is 100% equivalent to the previous one since <strong>r4 will end in a lower address than lr</strong>: remember our stack grows toward lower addresses, thus r4 which is in the top of the stack in factorial has the lowest address.</p>
<p>Remembering stmdb sp! and ldmia sp! may be a bit hard. Also, given that these two instructions will be relatively common when entering and leaving functions, GNU assembler provides two mnemonics push and pop for stmdb sp! and ldmia sp!, respectively. Note that these are not ARM instructions actually, just convenience names that are easier to remember.</p>
<p>The above program can be improved via <code>push</code> and <code>pop</code> as below:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource asm number-lines code-with-copy"><code class="sourceCode fasm"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">factorial:</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>    <span class="bu">push</span> <span class="op">{</span>r4<span class="op">,</span> lr<span class="op">}</span> <span class="op">/*</span> Push r4 <span class="op">and</span> lr onto the stack <span class="op">*/</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>     </span>
<span id="cb40-4"><a href="#cb40-4"></a>                       /* The stack is now <span class="dv">8</span> <span class="dt">byte</span> aligned <span class="op">*/</span></span>
<span id="cb40-5"><a href="#cb40-5"></a>    <span class="bu">mov</span> r4<span class="op">,</span> r0         <span class="op">/*</span> Keep a copy of the initial value of r0 in r4 <span class="op">*/</span></span>
<span id="cb40-6"><a href="#cb40-6"></a></span>
<span id="cb40-7"><a href="#cb40-7"></a></span>
<span id="cb40-8"><a href="#cb40-8"></a>    <span class="bu">cmp</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">0</span>         <span class="op">/*</span> compare r0 <span class="op">and</span> <span class="dv">0</span> <span class="op">*/</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>    bne is_nonzero     <span class="op">/*</span> if r0 <span class="op">!=</span> <span class="dv">0</span> then branch <span class="op">*/</span></span>
<span id="cb40-10"><a href="#cb40-10"></a>    <span class="bu">mov</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>         <span class="op">/*</span> r0 ← <span class="fl">1.</span> This is the return <span class="op">*/</span></span>
<span id="cb40-11"><a href="#cb40-11"></a>    b end</span>
<span id="cb40-12"><a href="#cb40-12"></a><span class="fu">is_nonzero:</span></span>
<span id="cb40-13"><a href="#cb40-13"></a>                       /* Prepare the call to factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb40-14"><a href="#cb40-14"></a>    <span class="bu">sub</span> r0<span class="op">,</span> r0<span class="op">,</span> <span class="op">#</span><span class="dv">1</span>     <span class="op">/*</span> r0 ← r0 <span class="op">-</span> <span class="dv">1</span> <span class="op">*/</span></span>
<span id="cb40-15"><a href="#cb40-15"></a>    bl factorial</span>
<span id="cb40-16"><a href="#cb40-16"></a>                       /* After the call r0 contains factorial<span class="op">(</span>n<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*/</span></span>
<span id="cb40-17"><a href="#cb40-17"></a>                       /* <span class="bu">Load</span> initial value of r0 <span class="op">(</span>that we kept in r4<span class="op">)</span> into r1 <span class="op">*/</span></span>
<span id="cb40-18"><a href="#cb40-18"></a>    <span class="bu">mov</span> r1<span class="op">,</span> r4         <span class="op">/*</span> r1 ← r4 <span class="op">*/</span></span>
<span id="cb40-19"><a href="#cb40-19"></a>    <span class="bu">mul</span> r0<span class="op">,</span> r0<span class="op">,</span> r1     <span class="op">/*</span> r0 ← r0 <span class="op">*</span> r1 <span class="op">*/</span></span>
<span id="cb40-20"><a href="#cb40-20"></a></span>
<span id="cb40-21"><a href="#cb40-21"></a><span class="fu">end:</span></span>
<span id="cb40-22"><a href="#cb40-22"></a>    <span class="bu">pop</span> <span class="op">{</span>r4<span class="op">,</span> lr<span class="op">}</span>    <span class="op">/*</span> Pop lr <span class="op">and</span> r4 from the stack <span class="op">*/</span></span>
<span id="cb40-23"><a href="#cb40-23"></a>    bx lr              <span class="op">/*</span> Leave factorial <span class="op">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="predication" class="level2">
<h2 class="anchored" data-anchor-id="predication">11 Predication</h2>
<p><a href="https://en.wikipedia.org/wiki/Predication_(computer_architecture)">Predication on wikipedia</a></p>
<p>Instruction suffix</p>
<p>eq, neq, le, lt, ge, gt, al(always, can be omitted)</p>
</section>
<section id="loops-and-the-status-register" class="level2">
<h2 class="anchored" data-anchor-id="loops-and-the-status-register">12 loops and the status register</h2>
<p>adds(add and update the cpsr)</p>
<p>subs</p>
<p>bpl(branch if plus, branch if the negative flag is clear)</p>
<section id="operating-64-bit-numbers" class="level3">
<h3 class="anchored" data-anchor-id="operating-64-bit-numbers">Operating 64 bit numbers</h3>
<p>adcs(add with carry, update the cpsr)</p>
<p>sbc(subtract with carry)</p>
<p>multiplication</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>